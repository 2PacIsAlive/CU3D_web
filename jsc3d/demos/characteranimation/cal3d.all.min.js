/*
 Cal3D 3d character animation library
 Copyright (C) 2001, 2002 Bruno 'Beosil' Heidelberger

 This library is free software; you can redistribute it and/or modify it
 under the terms of the GNU Lesser General Public License as published by
 the Free Software Foundation; either version 2.1 of the License, or (at
 your option) any later version.

 Cal3DJS Javascript port of Cal3D for WebGL and canvas applications
 by Humu humu2009@gmail.com
 http://code.google.com/p/cal3djs/
*/
var a,Cal3D=Cal3D||{};Cal3D.CalCoreAnimation=function(){this.m_listCallbacks=[];this.m_duration=0;this.m_listCoreTrack=[];this.m_filename=this.m_name=""};a=Cal3D.CalCoreAnimation.prototype;a.addCoreTrack=function(b){this.m_listCoreTrack.push(b);return true};a.getCoreTrack=function(b){for(var c=0;c<this.m_listCoreTrack.length;c++){var d=this.m_listCoreTrack[c];if(d.getCoreBoneId()==b)return d}return null};a.getDuration=function(){return this.m_duration};a.setDuration=function(b){this.m_duration=b};
a.scale=function(b){for(var c=0;c<this.m_listCoreTrack.length;c++)this.m_listCoreTrack[c].scale(b)};a.setFilename=function(b){this.m_filename=b};a.getFilename=function(){return this.m_filename};a.setName=function(b){this.m_name=b};a.getName=function(){return this.m_name};a.registerCallback=function(b,c){var d=new Cal3D.CalCoreAnimation.CallbackRecord;d.callback=b;d.min_interval=c;this.m_listCallbacks.push(d)};
a.removeCallback=function(b){for(var c=0;c<this.m_listCallbacks.length;c++)if(this.m_listCallbacks[c].callback==b){this.m_listCallbacks.splice(c,1);return}};a.getCallbackList=function(){return this.m_listCallbacks};a.getTrackCount=function(){return this.m_listCoreTrack.length};a.getListCoreTrack=function(){return this.m_listCoreTrack};a.getTotalNumberOfKeyframes=function(){for(var b=0,c=0;c<this.m_listCoreTrack.length;c++)b+=this.m_listCoreTrack[c].getCoreKeyframeCount();return b};
Cal3D.CalCoreAnimation.CallbackRecord=function(){this.callback=null;this.min_interval=0};Cal3D.CalCoreBone=function(b){this.m_name=b;this.m_coreSkeleton=null;this.m_parentId=-1;this.m_listChildId=[];this.m_translation=new Cal3D.CalVector;this.m_rotation=new Cal3D.CalQuaternion;this.m_translationAbsolute=new Cal3D.CalVector;this.m_rotationAbsolute=new Cal3D.CalQuaternion;this.m_translationBoneSpace=new Cal3D.CalVector;this.m_rotationBoneSpace=new Cal3D.CalQuaternion;this.m_userData=null;this.m_boundingBox=new Cal3D.CalBoundingBox;this.m_boundingPosition=[new Cal3D.CalVector,new Cal3D.CalVector,
new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector];this.m_boundingBoxPrecomputed=false};a=Cal3D.CalCoreBone.prototype;a.addChildId=function(b){this.m_listChildId.push(b);return true};
a.calculateState=function(){if(this.m_parentId==-1){this.m_translationAbsolute.assign(this.m_translation);this.m_rotationAbsolute.assign(this.m_rotation)}else{var b=this.m_coreSkeleton.getCoreBone(this.m_parentId);this.m_translationAbsolute.assign(this.m_translation);this.m_translationAbsolute.multQuaternionLocal(b.getRotationAbsolute());this.m_translationAbsolute.addLocal(b.getTranslationAbsolute());this.m_rotationAbsolute.assign(this.m_rotation);this.m_rotationAbsolute.multQuaternionLocal(b.getRotationAbsolute())}for(b=
0;b<this.m_listChildId.length;b++)this.m_coreSkeleton.getCoreBone(this.m_listChildId[b]).calculateState()};a.getListChildId=function(){return this.m_listChildId};a.getName=function(){return this.m_name};a.getParentId=function(){return this.m_parentId};a.getCoreSkeleton=function(){return this.m_coreSkeleton};a.getRotation=function(){return this.m_rotation};a.getRotationAbsolute=function(){return this.m_rotationAbsolute};a.getRotationBoneSpace=function(){return this.m_rotationBoneSpace};
a.getTranslation=function(){return this.m_translation};a.getTranslationAbsolute=function(){return this.m_translationAbsolute};a.getTranslationBoneSpace=function(){return this.m_translationBoneSpace};a.getUserData=function(){return this.m_userData};a.setCoreSkeleton=function(b){this.m_coreSkeleton=b};a.setParentId=function(b){this.m_parentId=b};a.setRotation=function(b){this.m_rotation.assign(b)};a.setRotationBoneSpace=function(b){this.m_rotationBoneSpace.assign(b)};a.setTranslation=function(b){this.m_translation.assign(b)};
a.setTranslationBoneSpace=function(b){this.m_translationBoneSpace.assign(b)};a.setUserData=function(b){this.m_userData=b};
a.calculateBoundingBox=function(b){var c=this.m_coreSkeleton.getCoreBoneId(this.m_name),d=false,e=new Cal3D.CalQuaternion(this.m_rotationBoneSpace);e.invert();var f=new Cal3D.CalVector(1,0,0);f.multQuaternionLocal(e);this.m_boundingBox.plane[0].setNormal(f);f.assign(-1,0,0);f.multQuaternionLocal(e);this.m_boundingBox.plane[1].setNormal(f);f.assign(0,1,0);f.multQuaternionLocal(e);this.m_boundingBox.plane[2].setNormal(f);f.assign(0,-1,0);f.multQuaternionLocal(e);this.m_boundingBox.plane[3].setNormal(f);
f.assign(0,0,1);f.multQuaternionLocal(e);this.m_boundingBox.plane[4].setNormal(f);f.assign(0,0,-1);f.multQuaternionLocal(e);this.m_boundingBox.plane[5].setNormal(f);e=b.getCoreMeshCount();for(f=0;f<e;f++)for(var g=b.getCoreMesh(f),h=g.getCoreSubmeshCount(),m=0;m<h;m++){var l=g.getCoreSubmesh(m);if(l.getSpringCount()==0){l=l.getVectorVertex();for(var p=0;p<l.length;p++)for(var q=l[p].vectorInfluence.length,o=0;o<q;o++)if(l[p].vectorInfluence[o].boneId==c&&l[p].vectorInfluence[o].weight>0.5)for(var k=
0;k<6;k++)if(this.m_boundingBox.plane[k].eval(l[p].position)<0){this.m_boundingBox.plane[k].setPosition(l[p].position);this.m_boundingPosition[k].assign(l[p].position);d=true}}}if(!d)for(k=0;k<6;k++){this.m_boundingBox.plane[k].setPosition(this.m_translation);this.m_boundingPosition[k].assign(this.m_translation)}this.m_boundingBoxPrecomputed=true};a.getBoundingBox=function(){return this.m_boundingBox};
a.getBoundingData=function(b,c){c||(c=new Cal3D.CalVector);c.assign(this.m_boundingPosition[b]);return c};a.isBoundingBoxPrecomputed=function(){return this.m_boundingBoxPrecomputed};a.scale=function(b){this.m_translation.multScalarLocal(b);this.m_translationAbsolute.multScalarLocal(b);this.m_translationBoneSpace.multScalarLocal(b);for(var c=0;c<this.m_listChildId.length;c++)this.m_coreSkeleton.getCoreBone(this.m_listChildId[c]).scale(b)};Cal3D.CalCoreKeyframe=function(){this.m_time=0;this.m_translation=new Cal3D.CalVector;this.m_rotation=new Cal3D.CalQuaternion};a=Cal3D.CalCoreKeyframe.prototype;a.create=function(){return true};a.destroy=function(){};a.getRotation=function(){return this.m_rotation};a.getTranslation=function(){return this.m_translation};a.getTime=function(){return this.m_time};a.setRotation=function(b){this.m_rotation.assign(b)};a.setTranslation=function(b){this.m_translation.assign(b)};
a.setTime=function(b){this.m_time=b};Cal3D.CalCoreMaterial=function(){this.m_ambientColor=new Cal3D.CalCoreMaterial.Color;this.m_diffuseColor=new Cal3D.CalCoreMaterial.Color;this.m_specularColor=new Cal3D.CalCoreMaterial.Color;this.m_shininess=0;this.m_vectorMap=[];this.m_userData=null;this.m_filename=this.m_name=""};a=Cal3D.CalCoreMaterial.prototype;a.getAmbientColor=function(){return this.m_ambientColor};a.getDiffuseColor=function(){return this.m_diffuseColor};a.getMapCount=function(){return this.m_vectorMap.length};
a.getMapFilename=function(b){if(b<0||b>=this.m_vectorMap.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"corematerial.js");return""}b=this.m_vectorMap[b];if(!b)return"";return b.filename};a.getMapUserData=function(b){if(b<0||b>=this.m_vectorMap.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"corematerial.js");return null}b=this.m_vectorMap[b];if(!b)return null;return b.userData};a.getShininess=function(){return this.m_shininess};a.getSpecularColor=function(){return this.m_specularColor};
a.getUserData=function(){return this.m_userData};a.getVectorMap=function(){return this.m_vectorMap};a.reserve=function(b){this.m_vectorMap=new Array(b);return true};a.setAmbientColor=function(b){this.m_ambientColor.red=b.red;this.m_ambientColor.green=b.green;this.m_ambientColor.blue=b.blue;this.m_ambientColor.alpha=b.alpha};a.setDiffuseColor=function(b){this.m_diffuseColor.red=b.red;this.m_diffuseColor.green=b.green;this.m_diffuseColor.blue=b.blue;this.m_diffuseColor.alpha=b.alpha};
a.setMap=function(b,c){if(b<0||b>=this.m_vectorMap.length)return false;this.m_vectorMap[b]=c;return true};a.setMapUserData=function(b,c){if(b<0||b>=this.m_vectorMap.length)return false;b=this.m_vectorMap[b];if(!b)return false;b.userData=c;return true};a.setShininess=function(b){this.m_shininess=b};a.setSpecularColor=function(b){this.m_specularColor.red=b.red;this.m_specularColor.green=b.green;this.m_specularColor.blue=b.blue;this.m_specularColor.alpha=b.alpha};
a.setFilename=function(b){this.m_filename=b};a.getFilename=function(){return this.m_filename};a.setName=function(b){this.m_name=b};a.getName=function(){return this.m_name};a.setUserData=function(b){this.m_userData=b};Cal3D.CalCoreMaterial.Color=function(){this.alpha=this.blue=this.green=this.red=0};Cal3D.CalCoreMaterial.Map=function(){this.filename="";this.userData=null};Cal3D.CalCoreMesh=function(){this.m_vectorCoreSubmesh=[];this.m_filename=this.m_name=""};a=Cal3D.CalCoreMesh.prototype;a.addCoreSubmesh=function(b){var c=this.m_vectorCoreSubmesh.length;this.m_vectorCoreSubmesh.push(b);return c};a.getCoreSubmesh=function(b){if(b<0||b>=this.m_vectorCoreSubmesh.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremesh.js");return null}return this.m_vectorCoreSubmesh[b]};a.getCoreSubmeshCount=function(){return this.m_vectorCoreSubmesh.length};
a.getVectorCoreSubmesh=function(){return this.m_vectorCoreSubmesh};
a.addAsMorphTarget=function(b){b=b.getVectorCoreSubmesh();if(this.m_vectorCoreSubmesh.length!=b.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INTERNAL,"coremesh.js");return-1}if(this.m_vectorCoreSubmesh.length==0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INTERNAL,"coremesh.js");return-1}for(var c=0,d=this.m_vectorCoreSubmesh[c].getCoreSubMorphTargetCount();c<this.m_vectorCoreSubmesh.length;){if(this.m_vectorCoreSubmesh[c].getVertexCount()!=b[c].getVertexCount()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INTERNAL,
"coremesh.js");return-1}c++}for(c=0;c<this.m_vectorCoreSubmesh.length;){var e=b[c].getVertexCount(),f=new Cal3D.CalCoreSubMorphTarget;if(!f.reserve(e))return-1;for(var g=b[c].getVectorVertex(),h=0,m=0;m<e;m++){var l=new Cal3D.CalCoreSubMorphTarget.BlendVertex;l.position.assign(g[h].position);l.normal.assign(g[h].normal);if(!f.setBlendVertex(m,l))return-1;h++}this.m_vectorCoreSubmesh[c].addCoreSubMorphTarget(f);c++}return d};a.scale=function(b){for(var c=0;c<this.m_vectorCoreSubmesh.length;c++)this.m_vectorCoreSubmesh[c].scale(b)};
a.setFilename=function(b){this.m_filename=b};a.getFilename=function(){return this.m_filename};a.setName=function(b){this.m_name=b};a.getName=function(){return this.m_name};Cal3D.CalCoreModel=function(b){this.m_name=b;this.m_coreSkeleton=null;this.m_vectorCoreAnimation=[];this.m_vectorCoreMorphAnimation=[];this.m_vectorCoreMesh=[];this.m_vectorCoreMaterial=[];this.m_mapmapCoreMaterialThread={};this.m_animationName={};this.m_materialName={};this.m_meshName={};this.m_userData=null};a=Cal3D.CalCoreModel.prototype;a.getUserData=function(){return this.m_userData};a.setUserData=function(b){this.m_userData=b};
a.scale=function(b){this.m_coreSkeleton.scale(b);for(var c=0;c<this.m_vectorCoreAnimation.length;c++)this.m_vectorCoreAnimation[c].scale(b);for(c=0;c<this.m_vectorCoreMesh.length;c++)this.m_vectorCoreMesh[c].scale(b)};a.addCoreAnimation=function(b){var c=this.m_vectorCoreAnimation.length;this.m_vectorCoreAnimation.push(b);return c};a.getCoreAnimation=function(b){if(b<0||b>=this.m_vectorCoreAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return null}return this.m_vectorCoreAnimation[b]};
a.getCoreAnimationCount=function(){return this.m_vectorCoreAnimation.length};a.loadCoreAnimation=function(){throw"not implemented error";};a.unloadCoreAnimation=function(b){if(typeof b=="string")b=this.getCoreAnimationId(b);if(b<0||b>=this.m_vectorCoreAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return-1}this.m_vectorCoreAnimation[b]=null;return b};a.saveCoreAnimation=function(){throw"not implemented error";};
a.addAnimationName=function(b,c){if(c<0||c>=this.m_vectorCoreAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return false}this.m_vectorCoreAnimation[c].setName(b);this.m_animationName[b]=c;return true};a.getCoreAnimationId=function(b){b=this.m_animationName[b];if(b==undefined)return-1;if(!this.getCoreAnimation(b))return-1;return b};
a.addCoreMorphAnimation=function(b){var c=this.m_vectorCoreMorphAnimation.length;this.m_vectorCoreMorphAnimation.push(b);return c};a.getCoreMorphAnimation=function(b){if(b<0||b>=this.m_vectorCoreMorphAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return null}return this.m_vectorCoreMorphAnimation[b]};a.getCoreMorphAnimationCount=function(){return this.m_vectorCoreMorphAnimation.length};
a.addCoreMaterial=function(b){var c=this.m_vectorCoreMaterial.length;this.m_vectorCoreMaterial.push(b);return c};a.createCoreMaterialThread=function(b){this.m_mapmapCoreMaterialThread[b]={};return true};a.getCoreMaterial=function(b){if(b<0||b>=this.m_vectorCoreMaterial.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return null}return this.m_vectorCoreMaterial[b]};a.getCoreMaterialCount=function(){return this.m_vectorCoreMaterial.length};
a.getCoreMaterialId=function(b){if(arguments.length==1){var c=this.m_materialName[b];if(c==undefined)return-1;if(!this.getCoreMaterial(c))return-1;return c}else if(arguments.length==2){c=arguments[1];var d=this.m_mapmapCoreMaterialThread[arguments[0]];if(d==undefined){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return-1}c=d[c];if(c==undefined){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return-1}return c}return-1};
a.loadCoreMaterial=function(){throw"not implemented error";};a.unloadCoreMaterial=function(b){if(typeof b=="string")b=this.getCoreMaterialId(b);if(b<0||b>=this.m_vectorCoreMaterial.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return-1}this.m_vectorCoreMaterial[b]=null;return b};a.saveCoreMaterial=function(){throw"not implemented error";};
a.setCoreMaterialId=function(b,c,d){b=this.m_mapmapCoreMaterialThread[b];if(b==undefined){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return false}b[c]=d;return true};a.addMaterialName=function(b,c){if(c<0||c>=this.m_vectorCoreMaterial.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return false}this.m_vectorCoreMaterial[c].setName(b);this.m_materialName[b]=c;return true};
a.addCoreMesh=function(b){var c=this.m_vectorCoreMesh.length;this.m_vectorCoreMesh.push(b);return c};a.getCoreMesh=function(b){if(b<0||b>=this.m_vectorCoreMesh.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return null}return this.m_vectorCoreMesh[b]};a.getCoreMeshCount=function(){return this.m_vectorCoreMesh.length};a.loadCoreMesh=function(){throw"not implemented error";};
a.unloadCoreMesh=function(b){if(typeof b=="string")b=this.getCoreMeshId(b);if(b<0||b>=this.m_vectorCoreMesh.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return-1}this.m_vectorCoreMesh[b]=null;return b};a.saveCoreMesh=function(){throw"not implemented error";};
a.addMeshName=function(b,c){if(c<0||c>=this.m_vectorCoreMesh.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js");return false}this.m_vectorCoreMesh[c].setName(b);this.m_meshName[b]=c;return true};a.getCoreMeshId=function(b){b=this.m_meshName[b];if(b==undefined)return-1;if(!this.getCoreMesh(b))return-1;return b};a.getCoreSkeleton=function(){return this.m_coreSkeleton};a.loadCoreSkeleton=function(){throw"not implemented error";};
a.saveCoreSkeleton=function(){throw"not implemented error";};a.setCoreSkeleton=function(b){if(b)this.m_coreSkeleton=b;else Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coremodel.js")};a.addBoneName=function(b,c){this.m_coreSkeleton&&this.m_coreSkeleton.mapCoreBoneName(c,b)};a.getBoneId=function(b){if(this.m_coreSkeleton)return this.m_coreSkeleton.getCoreBoneId(b);return-1};Cal3D.CalCoreMorphAnimation=function(){this.m_vectorCoreMeshID=[];this.m_vectorMorphTargetID=[]};Cal3D.CalCoreMorphAnimation.prototype.addMorphTarget=function(b,c){this.m_vectorCoreMeshID.push(b);this.m_vectorMorphTargetID.push(c);return true};Cal3D.CalCoreMorphAnimation.prototype.getVectorCoreMeshID=function(){return this.m_vectorCoreMeshID};Cal3D.CalCoreMorphAnimation.prototype.getVectorMorphTargetID=function(){return this.m_vectorMorphTargetID};Cal3D.CalCoreSkeleton=function(){this.m_vectorCoreBone=[];this.m_mapCoreBoneNames={};this.m_vectorRootCoreBoneId=[]};a=Cal3D.CalCoreSkeleton.prototype;a.addCoreBone=function(b){var c=this.m_vectorCoreBone.length;this.m_vectorCoreBone.push(b);b.getParentId()==-1&&this.m_vectorRootCoreBoneId.push(c);this.mapCoreBoneName(c,b.getName());return c};a.calculateState=function(){for(var b=0;b<this.m_vectorRootCoreBoneId.length;b++)this.m_vectorCoreBone[this.m_vectorRootCoreBoneId[b]].calculateState()};
a.getCoreBone=function(b){if(typeof b=="string")b=this.getCoreBoneId(b);if(b<0||b>=this.m_vectorCoreBone.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coreskeleton.js");return null}return this.m_vectorCoreBone[b]};a.getCoreBoneId=function(b){b=this.m_mapCoreBoneNames[b];if(b==undefined){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coreskeleton.js");return-1}return b};
a.mapCoreBoneName=function(b,c){if(b<0||b>=this.m_vectorCoreBone.length)return false;this.m_mapCoreBoneNames[c]=b;return true};a.getVectorRootCoreBoneId=function(){return this.m_vectorRootCoreBoneId};a.getVectorCoreBone=function(){return this.m_vectorCoreBone};a.calculateBoundingBoxes=function(b){for(var c=0;c<this.m_vectorCoreBone.length;c++)this.m_vectorCoreBone[c].calculateBoundingBox(b)};a.scale=function(b){for(var c=0;c<this.m_vectorRootCoreBoneId.length;c++)this.m_vectorCoreBone[c].scale(b)};Cal3D.CalCoreSubmesh=function(){this.m_vectorVertex=[];this.m_vectorTangentsEnabled=[];this.m_vectorvectorTangentSpace=[];this.m_vectorvectorTextureCoordinate=[];this.m_vectorPhysicalProperty=[];this.m_vectorFace=[];this.m_vectorSpring=[];this.m_vectorCoreSubMorphTarget=[];this.m_lodCount=this.m_coreMaterialThreadId=0};a=Cal3D.CalCoreSubmesh.prototype;a.getCoreMaterialThreadId=function(){return this.m_coreMaterialThreadId};a.getFaceCount=function(){return this.m_vectorFace.length};a.getLodCount=function(){return this.m_lodCount};
a.getSpringCount=function(){return this.m_vectorSpring.length};a.getVectorFace=function(){return this.m_vectorFace};a.getVectorPhysicalProperty=function(){return this.m_vectorPhysicalProperty};a.getVectorSpring=function(){return this.m_vectorSpring};a.getVectorVectorTangentSpace=function(){return this.m_vectorvectorTangentSpace};a.getVectorVectorTextureCoordinate=function(){return this.m_vectorvectorTextureCoordinate};a.getVectorVertex=function(){return this.m_vectorVertex};a.getVertexCount=function(){return this.m_vectorVertex.length};
a.isTangentsEnabled=function(b){if(b<0||b>=this.m_vectorTangentsEnabled.length)return false;return this.m_vectorTangentsEnabled[b]};
a.enableTangents=function(b,c){if(b<0||b>=this.m_vectorTangentsEnabled.length)return false;this.m_vectorTangentsEnabled[b]=c;if(!c){this.m_vectorvectorTangentSpace[b]=[];return true}this.m_vectorvectorTangentSpace[b]=new Array(this.m_vectorVertex.length);for(c=0;c<this.m_vectorvectorTangentSpace[b].length;c++)this.m_vectorvectorTangentSpace[b][c]=new Cal3D.CalCoreSubmesh.TangentSpace;for(c=0;c<this.m_vectorFace.length;c++){this.UpdateTangentVector(this.m_vectorFace[c].vertexId[0],this.m_vectorFace[c].vertexId[1],
this.m_vectorFace[c].vertexId[2],b);this.UpdateTangentVector(this.m_vectorFace[c].vertexId[1],this.m_vectorFace[c].vertexId[2],this.m_vectorFace[c].vertexId[0],b);this.UpdateTangentVector(this.m_vectorFace[c].vertexId[2],this.m_vectorFace[c].vertexId[0],this.m_vectorFace[c].vertexId[1],b)}for(c=0;c<this.m_vectorvectorTangentSpace[b].length;c++)this.m_vectorvectorTangentSpace[b][c].tangent.normalize();return true};
a.reserve=function(b,c,d,e){this.m_vectorVertex=new Array(b);this.m_vectorTangentsEnabled=new Array(c);this.m_vectorvectorTangentSpace=new Array(c);this.m_vectorvectorTextureCoordinate=new Array(c);for(var f=0;f<c;f++){this.m_vectorvectorTextureCoordinate[f]=new Array(b);this.m_vectorvectorTangentSpace[f]=this.m_vectorTangentsEnabled[f]?new Array(b):[]}this.m_vectorFace=new Array(d);this.m_vectorSpring=new Array(e);if(e>0)this.m_vectorPhysicalProperty=new Array(b);return true};
a.setCoreMaterialThreadId=function(b){this.m_coreMaterialThreadId=b};a.setFace=function(b,c){if(b<0||b>=this.m_vectorFace.length)return false;this.m_vectorFace[b]=c;return true};a.setLodCount=function(b){this.m_lodCount=b};a.setPhysicalProperty=function(b,c){if(b<0||b>=this.m_vectorPhysicalProperty.length)return false;this.m_vectorPhysicalProperty[b]=c;return true};a.setSpring=function(b,c){if(b<0||b>=this.m_vectorSpring.length)return false;this.m_vectorSpring[b]=c;return true};
a.setTangentSpace=function(b,c,d,e){if(b<0||b>=this.m_vectorVertex.length)return false;if(c<0||c>=this.m_vectorvectorTextureCoordinate.length)return false;if(!this.m_vectorTangentsEnabled[c])return false;this.m_vectorvectorTangentSpace[c][b].tangent.assign(d);this.m_vectorvectorTangentSpace[c][b].crossFactor=e;return true};
a.setTextureCoordinate=function(b,c,d){if(c<0||c>=this.m_vectorvectorTextureCoordinate.length)return false;if(b<0||b>=this.m_vectorvectorTextureCoordinate[c].length)return false;this.m_vectorvectorTextureCoordinate[c][b]=d;return true};a.setVertex=function(b,c){if(b<0||b>=this.m_vectorVertex.length)return false;this.m_vectorVertex[b]=c;return true};a.addCoreSubMorphTarget=function(b){var c=this.m_vectorCoreSubMorphTarget.length;this.m_vectorCoreSubMorphTarget.push(b);return c};
a.getCoreSubMorphTarget=function(b){if(b<0||b>=this.m_vectorCoreSubMorphTarget.length)return null;return this.m_vectorCoreSubMorphTarget[b]};a.getCoreSubMorphTargetCount=function(){return this.m_vectorCoreSubMorphTarget.length};a.getVectorCoreSubMorphTarget=function(){return this.m_vectorCoreSubMorphTarget};
a.scale=function(b){for(var c=0;c<this.m_vectorVertex.length;c++)this.m_vectorVertex[c].position.multScalarLocal(b);if(this.m_vectorSpring.length>0)if(Math.abs(b-1)>0.1){this.m_vectorSpring=[];this.m_vectorPhysicalProperty=[]}};
a.UpdateTangentVector=function(b,c,d,e){var f=this.getVectorVertex(),g=this.m_vectorvectorTextureCoordinate[e],h=g[c].u-g[b].u,m=g[c].v-g[b].v,l=g[d].u-g[b].u;g=g[d].v-g[b].v;var p=h*g-m*l;l=l*m-g*h;if(!(Math.abs(p)<1.0E-6||Math.abs(l)<1.0E-6)){h=g/p;m=m/l;c=Cal3D.vectorSub(f[c].position,f[b].position);d=Cal3D.vectorSub(f[d].position,f[b].position);d=c.multScalarLocal(h).addLocal(d.multScalarLocal(m));c=Cal3D.vectorDot(d,f[b].normal);d.subLocal(Cal3D.vectorScalarMult(f[b].normal,c));d.normalize();
this.m_vectorvectorTangentSpace[e][b].tangent.addLocal(d)}};Cal3D.CalCoreSubmesh.TextureCoordinate=function(){this.v=this.u=0};Cal3D.CalCoreSubmesh.TangentSpace=function(){this.tangent=new Cal3D.CalVector(0,0,0);this.crossFactor=1};Cal3D.CalCoreSubmesh.Influence=function(){this.weight=this.boneId=0};Cal3D.CalCoreSubmesh.PhysicalProperty=function(){this.weight=0};
Cal3D.CalCoreSubmesh.Vertex=function(){this.position=new Cal3D.CalVector;this.normal=new Cal3D.CalVector;this.vectorInfluence=[];this.faceCollapseCount=this.collapseId=0};Cal3D.CalCoreSubmesh.Face=function(){this.vertexId=[0,0,0]};Cal3D.CalCoreSubmesh.Spring=function(){this.vertexId=[0,0];this.idleLength=this.springCoefficient=0};Cal3D.CalCoreSubMorphTarget=function(){this.m_vectorBlendVertex=[]};Cal3D.CalCoreSubMorphTarget.prototype.getBlendVertexCount=function(){return this.m_vectorBlendVertex.length};Cal3D.CalCoreSubMorphTarget.prototype.getVectorBlendVertex=function(){return this.m_vectorBlendVertex};Cal3D.CalCoreSubMorphTarget.prototype.reserve=function(b){this.m_vectorBlendVertex=new Array(b);return true};
Cal3D.CalCoreSubMorphTarget.prototype.setBlendVertex=function(b,c){if(b<0||b>=this.m_vectorBlendVertex.length)return false;this.m_vectorBlendVertex[b]=c;return true};Cal3D.CalCoreSubMorphTarget.BlendVertex=function(){this.position=new Cal3D.CalVector;this.normal=new Cal3D.CalVector};Cal3D.CalCoreTrack=function(){this.m_coreBoneId=-1;this.m_keyframes=[]};a=Cal3D.CalCoreTrack.prototype;a.create=function(){return true};a.destroy=function(){for(var b=0;b<this.m_keyframes.length;b++)this.m_keyframes[b].destroy();this.m_keyframes=[];this.m_coreBoneId=-1};
a.getState=function(b,c,d){var e;e=this.getUpperBound(b);if(e==this.m_keyframes.length){e--;d.assign(this.m_keyframes[e].getRotation());c.assign(this.m_keyframes[e].getTranslation());return true}if(e==0){d.assign(this.m_keyframes[e].getRotation());c.assign(this.m_keyframes[e].getTranslation());return true}var f;f=this.m_keyframes[e-1];e=this.m_keyframes[e];b=(b-f.getTime())/(e.getTime()-f.getTime());c.assign(f.getTranslation());c.blend(b,e.getTranslation());d.assign(f.getRotation());d.blend(b,e.getRotation());
return true};a.getCoreBoneId=function(){return this.m_coreBoneId};a.setCoreBoneId=function(b){if(b<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"coretrack.js");return false}this.m_coreBoneId=b;return true};a.getCoreKeyframeCount=function(){return this.m_keyframes.length};a.getCoreKeyframe=function(b){return this.m_keyframes[b]};
a.addCoreKeyframe=function(b){this.m_keyframes.push(b);for(b=this.m_keyframes.length-1;b>0&&this.m_keyframes[b].getTime()<this.m_keyframes[b-1].getTime();){var c=this.m_keyframes[b];this.m_keyframes[b]=this.m_keyframes[b-1];this.m_keyframes[b-1]=c;b--}return true};a.removeCoreKeyFrame=function(b){this.m_keyframes.splice(b,1)};a.scale=function(b){for(var c=0;c<this.m_keyframes.length;c++)this.m_keyframes[c].getTranslation().multScalarLocal(b)};
a.getUpperBound=function(b){for(var c=0,d=this.m_keyframes.length-1;c<d-1;){var e=c+d>>1;if(b>=this.m_keyframes[e].getTime())c=e;else d=e}return d};Cal3D.CalAnimation=function(b){this.m_coreAnimation=b;this.m_lastCallbackTimes=[];this.m_type=Cal3D.CalAnimation.Type.TYPE_NONE;this.m_state=Cal3D.CalAnimation.State.STATE_NONE;this.m_time=0;this.m_timeFactor=1;this.m_weight=0;b=b.getCallbackList();for(var c=0;c<b.length;c++)this.m_lastCallbackTimes.push(0)};Cal3D.CalAnimation.Type={TYPE_NONE:0,TYPE_CYCLE:1,TYPE_POSE:2,TYPE_ACTION:3};Cal3D.CalAnimation.State={STATE_NONE:0,STATE_SYNC:1,STATE_ASYNC:2,STATE_IN:3,STATE_STEADY:4,STATE_OUT:5,STATE_STOPPED:6};
a=Cal3D.CalAnimation.prototype;a.getCoreAnimation=function(){return this.m_coreAnimation};a.getState=function(){return this.m_state};a.getTime=function(){return this.m_time};a.getType=function(){return this.m_type};a.getWeight=function(){return this.m_weight};a.setTime=function(b){this.m_time=b};a.setTimeFactor=function(b){this.m_timeFactor=b};a.getTimeFactor=function(){return this.m_timeFactor};
a.checkCallbacks=function(b,c){for(var d=this.m_coreAnimation.getCallbackList(),e=0;e<d.length;e++){this.m_lastCallbackTimes.length<=e&&this.m_lastCallbackTimes.push(b);d[e].callback.AnimationUpdate(b,c,c.getUserData());if(b>0&&b<this.m_lastCallbackTimes[e])this.m_lastCallbackTimes[e]-=this.m_coreAnimation.getDuration();else if(b<0&&b>this.m_lastCallbackTimes[e])this.m_lastCallbackTimes[e]+=this.m_coreAnimation.getDuration();if(b>=0&&b>=this.m_lastCallbackTimes[e]+d[e].min_interval||b<0&&b<=this.m_lastCallbackTimes[e]-
d[e].min_interval){d[e].callback.AnimationUpdate(b,c,c.getUserData());this.m_lastCallbackTimes[e]=b}}};a.completeCallbacks=function(b){for(var c=this.m_coreAnimation.getCallbackList(),d=0;d<c.length;d++)c[d].callback.AnimationComplete(b,b.getUserData())};a.setType=function(b){this.m_type=b};a.setState=function(b){this.m_state=b};a.setWeight=function(b){this.m_weight=b};Cal3D.CalAnimationCallback=function(){};Cal3D.CalAnimationCallback.prototype.AnimationUpdate=function(){};
Cal3D.CalAnimationCallback.prototype.AnimationComplete=function(){};Cal3D.CalAnimationAction=function(b){Cal3D.CalAnimation.call(this,b);this.m_weightTarget=this.m_delayTarget=this.m_delayOut=this.m_delayIn=0;this.m_autoLock=false;this.setType(Cal3D.CalAnimation.Type.TYPE_ACTION)};Cal3D.CalAnimationAction.prototype=new Cal3D.CalAnimation(new Cal3D.CalCoreAnimation);
Cal3D.CalAnimationAction.prototype.execute=function(b,c,d,e){if(d==undefined)d=1;if(e==undefined)e=false;this.setState(Cal3D.CalAnimation.State.STATE_IN);this.setWeight(0);this.m_delayIn=b;this.m_delayOut=c;this.setTime(0);this.m_weightTarget=d;this.m_autoLock=e;return true};
Cal3D.CalAnimationAction.prototype.update=function(b){this.getState()!=Cal3D.CalAnimation.State.STATE_STOPPED&&this.setTime(this.getTime()+b*this.getTimeFactor());if(this.getState()==Cal3D.CalAnimation.State.STATE_IN)if(this.getTime()<this.m_delayIn)this.setWeight(this.getTime()/this.m_delayIn*this.m_weightTarget);else{this.setState(Cal3D.CalAnimation.State.STATE_STEADY);this.setWeight(this.m_weightTarget)}if(this.getState()==Cal3D.CalAnimation.State.STATE_STEADY)if(!this.m_autoLock&&this.getTime()>=
this.getCoreAnimation().getDuration()-this.m_delayOut)this.setState(Cal3D.CalAnimation.State.STATE_OUT);else if(this.m_autoLock&&this.getTime()>this.getCoreAnimation().getDuration()){this.setState(Cal3D.CalAnimation.State.STATE_STOPPED);this.setTime(this.getCoreAnimation().getDuration())}if(this.getState()==Cal3D.CalAnimation.State.STATE_OUT)if(this.getTime()<this.getCoreAnimation().getDuration())this.setWeight((this.getCoreAnimation().getDuration()-this.getTime())/this.m_delayOut*this.m_weightTarget);
else{this.setWeight(0);return false}return true};Cal3D.CalAnimationCycle=function(b){Cal3D.CalAnimation.call(this,b);this.m_targetWeight=this.m_targetDelay=0;this.setType(Cal3D.CalAnimation.Type.TYPE_CYCLE);this.setState(Cal3D.CalAnimation.State.STATE_SYNC);this.setWeight(0)};Cal3D.CalAnimationCycle.prototype=new Cal3D.CalAnimation(new Cal3D.CalCoreAnimation);Cal3D.CalAnimationCycle.prototype.blend=function(b,c){this.m_targetWeight=b;this.m_targetDelay=c;return true};
Cal3D.CalAnimationCycle.prototype.setAsync=function(b,c){if(this.getState()!=Cal3D.CalAnimation.State.STATE_ASYNC){if(c==0){this.setTimeFactor(1);this.setTime(0)}else{this.setTimeFactor(this.getCoreAnimation().getDuration()/c);this.setTime(b*this.getTimeFactor())}this.setState(Cal3D.CalAnimation.State.STATE_ASYNC)}};
Cal3D.CalAnimationCycle.prototype.update=function(b){if(this.m_targetDelay<=Math.abs(b)){this.setWeight(this.m_targetWeight);this.m_targetDelay=0;if(this.getWeight()==0)return false}else{var c=b/this.m_targetDelay;this.setWeight((1-c)*this.getWeight()+c*this.m_targetWeight);this.m_targetDelay-=b}if(this.getState()==Cal3D.CalAnimation.State.STATE_ASYNC){this.setTime(this.getTime()+b*this.getTimeFactor());this.getTime()>=this.getCoreAnimation().getDuration()&&this.setTime(this.getTime()%this.getCoreAnimation().getDuration());
this.getTime()<0&&this.setTime(this.getTime()+this.getCoreAnimation().getDuration())}return true};Cal3D.CalBone=function(b){this.m_coreBone=b;this.m_skeleton=null;this.m_accumulatedWeightAbsolute=this.m_accumulatedWeight=0;this.m_translation=new Cal3D.CalVector;this.m_rotation=new Cal3D.CalQuaternion;this.m_translationAbsolute=new Cal3D.CalVector;this.m_rotationAbsolute=new Cal3D.CalQuaternion;this.m_translationBoneSpace=new Cal3D.CalVector;this.m_rotationBoneSpace=new Cal3D.CalQuaternion;this.m_transformMatrix=new Cal3D.CalMatrix;this.m_boundingBox=new Cal3D.CalBoundingBox;this.clearState()};
a=Cal3D.CalBone.prototype;a.blendState=function(b,c,d){if(this.m_accumulatedWeightAbsolute==0){this.m_translationAbsolute.assign(c);this.m_rotationAbsolute.assign(d);this.m_accumulatedWeightAbsolute=b}else{var e=b/(this.m_accumulatedWeightAbsolute+b);this.m_translationAbsolute.blend(e,c);this.m_rotationAbsolute.blend(e,d);this.m_accumulatedWeightAbsolute+=b}};
a.calculateState=function(){if(this.m_accumulatedWeight==0){this.m_translation.assign(this.m_coreBone.getTranslation());this.m_rotation.assign(this.m_coreBone.getRotation())}var b=this.m_coreBone.getParentId();if(b==-1){this.m_translationAbsolute.assign(this.m_translation);this.m_rotationAbsolute.assign(this.m_rotation)}else{b=this.m_skeleton.getBone(b);this.m_translationAbsolute.assign(this.m_translation);this.m_translationAbsolute.multQuaternionLocal(b.getRotationAbsolute());this.m_translationAbsolute.addLocal(b.getTranslationAbsolute());
this.m_rotationAbsolute.assign(this.m_rotation);this.m_rotationAbsolute.multQuaternionLocal(b.getRotationAbsolute())}this.m_translationBoneSpace.assign(this.m_coreBone.getTranslationBoneSpace());this.m_translationBoneSpace.multQuaternionLocal(this.m_rotationAbsolute);this.m_translationBoneSpace.addLocal(this.m_translationAbsolute);this.m_rotationBoneSpace.assign(this.m_coreBone.getRotationBoneSpace());this.m_rotationBoneSpace.multQuaternionLocal(this.m_rotationAbsolute);this.m_transformMatrix.assign(this.m_rotationBoneSpace);
b=this.m_coreBone.getListChildId();for(var c=0;c<b.length;c++)this.m_skeleton.getBone(b[c]).calculateState()};a.clearState=function(){this.m_accumulatedWeightAbsolute=this.m_accumulatedWeight=0};a.getCoreBone=function(){return this.m_coreBone};a.setCoreState=function(){this.m_translation.assign(this.m_coreBone.getTranslation());this.m_rotation.assign(this.m_coreBone.getRotation());this.m_accumulatedWeight=this.m_accumulatedWeightAbsolute=1;this.calculateState()};
a.setCoreStateRecursive=function(){this.m_translation.assign(this.m_coreBone.getTranslation());this.m_rotation.assign(this.m_coreBone.getRotation());this.m_accumulatedWeight=this.m_accumulatedWeightAbsolute=1;for(var b=this.m_coreBone.getListChildId(),c=0;c<b.length;c++)this.m_skeleton.getBone(b[c]).setCoreStateRecursive();this.calculateState()};a.setRotation=function(b){this.m_rotation.assign(b);this.m_accumulatedWeight=this.m_accumulatedWeightAbsolute=1};a.getRotation=function(){return this.m_rotation};
a.getRotationAbsolute=function(){return this.m_rotationAbsolute};a.getRotationBoneSpace=function(){return this.m_rotationBoneSpace};a.setTranslation=function(b){this.m_translation.assign(b);this.m_accumulatedWeight=this.m_accumulatedWeightAbsolute=1};a.getTranslation=function(){return this.m_translation};a.getTranslationAbsolute=function(){return this.m_translationAbsolute};a.getTranslationBoneSpace=function(){return this.m_translationBoneSpace};a.getTransformMatrix=function(){return this.m_transformMatrix};
a.lockState=function(){if(this.m_accumulatedWeightAbsolute>1-this.m_accumulatedWeight)this.m_accumulatedWeightAbsolute=1-this.m_accumulatedWeight;if(this.m_accumulatedWeightAbsolute>0){if(this.m_accumulatedWeight==0){this.m_translation.assign(this.m_translationAbsolute);this.m_rotation.assign(this.m_rotationAbsolute);this.m_accumulatedWeight=this.m_accumulatedWeightAbsolute}else{var b=this.m_accumulatedWeightAbsolute/(this.m_accumulatedWeight+this.m_accumulatedWeightAbsolute);this.m_translation.blend(b,
this.m_translationAbsolute);this.m_rotation.blend(b,this.m_rotationAbsolute);this.m_accumulatedWeight+=this.m_accumulatedWeightAbsolute}this.m_accumulatedWeightAbsolute=0}};a.setSkeleton=function(b){this.m_skeleton=b};
a.calculateBoundingBox=function(){if(this.getCoreBone().isBoundingBoxPrecomputed()){var b=new Cal3D.CalVector(1,0,0);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[0].setNormal(b);b.assign(-1,0,0);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[1].setNormal(b);b.assign(0,1,0);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[2].setNormal(b);b.assign(0,-1,0);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[3].setNormal(b);
b.assign(0,0,1);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[4].setNormal(b);b.assign(0,0,-1);b.multMatrixLocal(this.getTransformMatrix());this.m_boundingBox.plane[5].setNormal(b);b=new Cal3D.CalVector;for(var c=0;c<6;c++){this.getCoreBone().getBoundingData(c,b);b.multMatrixLocal(this.getTransformMatrix());b.addLocal(this.getTranslationBoneSpace());for(var d=0;d<6;d++)this.m_boundingBox.plane[d].eval(b)<0&&this.m_boundingBox.plane[d].setPosition(b)}}};a.getBoundingBox=function(){return this.m_boundingBox};Cal3D.CalMesh=function(b){this.m_model=null;this.m_coreMesh=b;this.m_vectorSubmesh=[];b=b.getVectorCoreSubmesh();for(var c=b.length,d=0;d<c;d++)this.m_vectorSubmesh.push(new Cal3D.CalSubmesh(b[d]))};a=Cal3D.CalMesh.prototype;a.getCoreMesh=function(){return this.m_coreMesh};a.getSubmesh=function(b){if(b<0||b>=this.m_vectorSubmesh.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"mesh.js");return null}return this.m_vectorSubmesh[b]};a.getSubmeshCount=function(){return this.m_vectorSubmesh.length};
a.getVectorSubmesh=function(){return this.m_vectorSubmesh};a.setLodLevel=function(b){for(var c=0;c<this.m_vectorSubmesh.length;c++)this.m_vectorSubmesh[c].setLodLevel(b)};a.setMaterialSet=function(b){for(var c=0;c<this.m_vectorSubmesh.length;c++){var d=this.m_vectorSubmesh[c].getCoreSubmesh().getCoreMaterialThreadId();d=this.m_model.getCoreModel().getCoreMaterialId(d,b);this.m_vectorSubmesh[c].setCoreMaterialId(d)}};a.setModel=function(b){this.m_model=b};
a.disableInternalData=function(){for(var b=0;b<this.m_vectorSubmesh.length;b++)this.m_vectorSubmesh[b].disableInternalData()};Cal3D.CalModel=function(b){this.m_coreModel=b;this.m_skeleton=new Cal3D.CalSkeleton(b.getCoreSkeleton());this.m_mixer=new Cal3D.CalMixer(this);this.m_morphTargetMixer=new Cal3D.CalMorphTargetMixer(this);this.m_physique=new Cal3D.CalPhysique(this);this.m_springSystem=new Cal3D.CalSpringSystem(this);this.m_renderer=new Cal3D.CalRenderer(this);this.m_userData=null;this.m_vectorMesh=[];this.m_boundingBox=new Cal3D.CalBoundingBox};a=Cal3D.CalModel.prototype;
a.attachMesh=function(b){if(b<0||b>=this.m_coreModel.getCoreMeshCount()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"model.js");return false}b=this.m_coreModel.getCoreMesh(b);for(var c=0;c<this.m_vectorMesh.length;c++)if(this.m_vectorMesh[c].getCoreMesh()==b)return true;b=new Cal3D.CalMesh(b);b.setModel(this);this.m_vectorMesh.push(b);return true};
a.detachMesh=function(b){if(b<0||b>=this.m_coreModel.getCoreMeshCount()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"model.js");return false}b=this.m_coreModel.getCoreMesh(b);for(var c=0;c<this.m_vectorMesh.length;c++)if(this.m_vectorMesh[c].getCoreMesh()==b){this.m_vectorMesh.splice(c,1);return true}return false};a.getCoreModel=function(){return this.m_coreModel};
a.getMesh=function(b){if(b<0||b>=this.m_coreModel.getCoreMeshCount()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"model.js");return null}b=this.m_coreModel.getCoreMesh(b);for(var c=0;c<this.m_vectorMesh.length;c++)if(this.m_vectorMesh[c].getCoreMesh()==b)return this.m_vectorMesh[c];return null};a.getMixer=function(){if(!this.m_mixer)return null;if(!this.m_mixer.isDefaultMixer()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_MIXER_TYPE,"model.js");return null}return this.m_mixer};
a.getAbstractMixer=function(){return this.m_mixer};a.setAbstractMixer=function(b){this.m_mixer=b};a.getMorphTargetMixer=function(){return this.m_morphTargetMixer};a.getPhysique=function(){return this.m_physique};a.getRenderer=function(){return this.m_renderer};a.getSkeleton=function(){return this.m_skeleton};a.getSpringSystem=function(){return this.m_springSystem};
a.getBoundingBox=function(b){var c=new Cal3D.CalVector(1,0,0);this.m_boundingBox.plane[0].setNormal(c);c.assign(-1,0,0);this.m_boundingBox.plane[1].setNormal(c);c.assign(0,1,0);this.m_boundingBox.plane[2].setNormal(c);c.assign(0,-1,0);this.m_boundingBox.plane[3].setNormal(c);c.assign(0,0,1);this.m_boundingBox.plane[4].setNormal(c);c.assign(0,0,-1);this.m_boundingBox.plane[5].setNormal(c);b&&this.m_skeleton.calculateBoundingBoxes();c=this.m_skeleton.getVectorBone();for(var d=[new Cal3D.CalVector,new Cal3D.CalVector,
new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector,new Cal3D.CalVector],e=0;e<c.length;e++){var f=c[e];if(!b||!f.getCoreBone().isBoundingBoxPrecomputed()){var g=f.getTranslationAbsolute();for(f=0;f<6;f++)this.m_boundingBox.plane[f].eval(g)<0&&this.m_boundingBox.plane[f].setPosition(g)}else{f.getBoundingBox().computePoints(d);for(g=0;g<8;g++)for(f=0;f<6;f++)this.m_boundingBox.plane[f].eval(d[g])<0&&this.m_boundingBox.plane[f].setPosition(d[g])}}return this.m_boundingBox};
a.getUserData=function(){return this.m_userData};a.getVectorMesh=function(){return this.m_vectorMesh};a.setLodLevel=function(b){for(var c=0;c<this.m_vectorMesh.length;c++)this.m_vectorMesh[c].setLodLevel(b)};a.setMaterialSet=function(b){for(var c=0;c<this.m_vectorMesh.length;c++)this.m_vectorMesh[c].setMaterialSet(b)};a.setUserData=function(b){this.m_userData=b};
a.update=function(b){this.m_mixer.updateAnimation(b);this.m_mixer.updateSkeleton();this.m_morphTargetMixer.update(b);this.m_physique.update();this.m_springSystem.update(b)};a.disableInternalData=function(){for(var b=0;b<this.m_vectorMesh.length;b++)this.m_vectorMesh[b].disableInternalData()};Cal3D.CalSubmesh=function(b){this.m_coreSubmesh=b;this.m_vectorMorphTargetWeight=new Array(b.getCoreSubMorphTargetCount());this.m_vectorVertex=[];this.m_vectorNormal=[];this.m_vectorvectorTangentSpace=[];this.m_vectorFace=new Array(b.getFaceCount());this.m_vectorPhysicalProperty=[];this.m_faceCount=this.m_vertexCount=0;this.m_coreMaterialId=-1;this.m_bInternalData=false;for(var c=0;c<this.m_vectorFace.length;c++)this.m_vectorFace[c]=new Cal3D.CalSubmesh.Face;this.setLodLevel(1);c=b.getCoreSubMorphTargetCount();
for(var d=0;d<c;d++)this.m_vectorMorphTargetWeight[d]=0;if(b.getSpringCount()>0){c=b.getVertexCount();this.m_vectorVertex=new Array(c);this.m_vectorNormal=new Array(c);this.m_vectorvectorTangentSpace=new Array(b.getVectorVectorTangentSpace().length);this.m_vectorPhysicalProperty=new Array(c);b=b.getVectorVertex();for(d=0;d<c;d++){this.m_vectorVertex[d]=new Cal3D.CalVector(b[d].position);var e=new Cal3D.CalSubmesh.PhysicalProperty;e.position.assign(b[d].position);e.positionOld.assign(b[d].position);
this.m_vectorPhysicalProperty[d]=e;this.m_vectorNormal[d]=new Cal3D.CalVector(b[d].normal)}this.m_bInternalData=true}};a=Cal3D.CalSubmesh.prototype;a.getCoreSubmesh=function(){return this.m_coreSubmesh};a.getCoreMaterialId=function(){return this.m_coreMaterialId};a.getFaceCount=function(){return this.m_faceCount};a.getFaces=function(b){for(var c=0,d=0;c<this.m_faceCount;c++,d+=3){var e=this.m_vectorFace[c].vertexId;b[d]=e[0];b[d+1]=e[1];b[d+2]=e[2]}return this.m_faceCount};a.getVectorNormal=function(){return this.m_vectorNormal};
a.getVectorVectorTangentSpace=function(){return this.m_vectorvectorTangentSpace};a.getVectorPhysicalProperty=function(){return this.m_vectorPhysicalProperty};a.getVectorVertex=function(){return this.m_vectorVertex};a.getVertexCount=function(){return this.m_vertexCount};a.hasInternalData=function(){return this.m_bInternalData};
a.disableInternalData=function(){if(this.m_bInternalData){this.m_vectorVertex=[];this.m_vectorNormal=[];this.m_vectorvectorTangentSpace=[];this.m_vectorPhysicalProperty=[];this.m_bInternalData=false}};a.setCoreMaterialId=function(b){this.m_coreMaterialId=b};
a.setLodLevel=function(b){if(b<0)b=0;if(b>1)b=1;var c=this.m_coreSubmesh.getLodCount();c=~~((1-b)*c);this.m_vertexCount=this.m_coreSubmesh.getVertexCount()-c;b=this.m_coreSubmesh.getVectorFace();c=this.m_coreSubmesh.getVectorVertex();this.m_faceCount=b.length;for(var d=c.length-1;d>=this.m_vertexCount;d--)this.m_faceCount-=c[d].faceCollapseCount;for(var e=0;e<this.m_faceCount;e++)for(d=0;d<3;d++){for(var f=b[e].vertexId[d];f>=this.m_vertexCount;)f=c[f].collapseId;this.m_vectorFace[e].vertexId[d]=
f}};a.isTangentsEnabled=function(b){return this.m_coreSubmesh.isTangentsEnabled(b)};
a.enableTangents=function(b,c){if(!this.m_coreSubmesh.enableTangents(b,c))return false;if(!this.m_bInternalData)return true;if(!c){this.m_vectorvectorTangentSpace[b]=[];return true}this.m_vectorvectorTangentSpace[b]=new Array(this.m_coreSubmesh.getVertexCount());c=this.m_coreSubmesh.getVectorVectorTangentSpace()[b];for(var d=this.m_coreSubmesh.getVertexCount(),e=0;e<d;e++){var f=new Cal3D.CalSubmesh.TangentSpace;f.tangent.assign(c[e].tangent);f.crossFactor=c[e].crossFactor;this.m_vectorvectorTangentSpace[b][e]=
f}return true};a.getVectorWeight=function(){throw"not implemented error";};a.setMorphTargetWeight=function(b,c){this.m_vectorMorphTargetWeight[b]=c};a.getMorphTargetWeight=function(b){return this.m_vectorMorphTargetWeight[b]};a.getBaseWeight=function(){for(var b=1,c=this.getMorphTargetWeightCount(),d=0;d<c;d++)b-=this.m_vectorMorphTargetWeight[d];return b};a.getMorphTargetWeightCount=function(){return this.m_vectorMorphTargetWeight.length};a.getVectorMorphTargetWeight=function(){return this.m_vectorMorphTargetWeight};
Cal3D.CalSubmesh.PhysicalProperty=function(){this.position=new Cal3D.CalVector;this.positionOld=new Cal3D.CalVector;this.force=new Cal3D.CalVector};Cal3D.CalSubmesh.TangentSpace=function(){this.tangent=new Cal3D.CalVector;this.crossFactor=0};Cal3D.CalSubmesh.Face=function(){this.vertexId=[0,0,0]};Cal3D.CalSkeleton=function(b){this.m_coreSkeleton=b;this.m_vectorBone=[];this.m_isBoundingBoxesComputed=false;b=b.getVectorCoreBone();for(var c=b.length,d=0;d<c;d++){var e=new Cal3D.CalBone(b[d]);e.setSkeleton(this);this.m_vectorBone.push(e)}};a=Cal3D.CalSkeleton.prototype;a.calculateState=function(){for(var b=this.m_coreSkeleton.getVectorRootCoreBoneId(),c=0;c<b.length;c++)this.m_vectorBone[b[c]].calculateState();this.m_isBoundingBoxesComputed=false};
a.clearState=function(){for(var b=0;b<this.m_vectorBone.length;b++)this.m_vectorBone[b].clearState();this.m_isBoundingBoxesComputed=false};a.create=function(){throw"not implemented error";};a.getBone=function(b){return this.m_vectorBone[b]};a.getCoreSkeleton=function(){return this.m_coreSkeleton};a.getVectorBone=function(){return this.m_vectorBone};a.getBoneCount=function(){return this.m_vectorBone.length};a.lockState=function(){for(var b=0;b<this.m_vectorBone.length;b++)this.m_vectorBone[b].lockState()};
a.getBoneBoundingBox=function(b,c){b||(b=new Cal3D.CalVector);c||(c=new Cal3D.CalVector);this.m_isBoundingBoxesComputed||this.calculateBoundingBoxes();var d=0;if(this.m_vectorBone.length>0){var e=this.m_vectorBone[d].getTranslationAbsolute();b.assign(e);c.assign(e);d++}for(;d<this.m_vectorBone.length;d++){e=this.m_vectorBone[d].getTranslationAbsolute();if(e.x>c.x)c.x=e.x;else if(e.x<b.x)b.x=e.x;if(e.y>c.y)c.y=e.y;else if(e.y<b.y)b.y=e.y;if(e.z>c.z)c.z=e.z;else if(e.z<b.z)b.z=e.z}return{min:b,max:c}};
a.calculateBoundingBoxes=function(){if(!this.m_isBoundingBoxesComputed){for(var b=0;b<this.m_vectorBone.length;b++)this.m_vectorBone[b].calculateBoundingBox();this.m_isBoundingBoxesComputed=true}};a.getBonePoints=function(b){for(var c=this.m_vectorBone.length,d=0,e=0;e<c;e++){var f=this.m_vectorBone[e].getTranslationAbsolute();b[d]=f.x;b[d+1]=f.y;b[d+2]=f.z;d+=3}return c};
a.getBonePointsStatic=function(b){for(var c=this.m_vectorBone.length,d=0,e=0;e<c;e++){var f=this.m_vectorBone[e].getCoreBone().getTranslationAbsolute();b[d]=f.x;b[d+1]=f.y;b[d+2]=f.z;d+=3}return c};a.getBoneLines=function(b){for(var c=this.m_vectorBone.length,d=0,e=0,f=0;f<c;f++){var g=this.m_vectorBone[f],h=g.getCoreBone().getParentId();if(h!=-1){h=this.m_vectorBone[h];g=g.getTranslationAbsolute();h=h.getTranslationAbsolute();b[d]=h.x;b[d+1]=h.y;b[d+2]=h.z;b[d+3]=g.x;b[d+4]=g.y;b[d+5]=g.z;d+=6;e++}}return e};
a.getBoneLinesStatic=function(b){for(var c=this.m_vectorBone.length,d=0,e=0,f=0;f<c;f++){var g=this.m_vectorBone[f],h=g.getCoreBone().getParentId();if(h!=-1){h=this.m_vectorBone[h];g=g.getCoreBone().getTranslationAbsolute();h=h.getCoreBone().getTranslationAbsolute();b[d]=h.x;b[d+1]=h.y;b[d+2]=h.z;b[d+3]=g.x;b[d+4]=g.y;b[d+5]=g.z;d+=6;e++}}return e};Cal3D.CalMorphTargetMixer=function(b){this.m_model=b;this.m_vectorCurrentWeight=[];this.m_vectorEndWeight=[];this.m_vectorDuration=[];b=b.getCoreModel().getCoreMorphAnimationCount();for(var c=0;c<b;c++){this.m_vectorCurrentWeight.push(0);this.m_vectorEndWeight.push(0);this.m_vectorDuration.push(0)}};a=Cal3D.CalMorphTargetMixer.prototype;
a.blend=function(b,c,d){if(b<0||b>=this.m_vectorCurrentWeight.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"morphtargetmixer.js");return false}this.m_vectorEndWeight[b]=c;this.m_vectorDuration[b]=d;return true};a.clear=function(b,c){if(b<0||b>=this.m_vectorCurrentWeight.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"morphtargetmixer.js");return false}this.m_vectorEndWeight[b]=0;this.m_vectorDuration[b]=c;return true};
a.getCurrentWeight=function(b){if(b<0||b>=this.m_vectorCurrentWeight.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"morphtargetmixer.js");return 0}return this.m_vectorCurrentWeight[b]};a.getCurrentWeightBase=function(){for(var b=1,c=0;c<this.m_vectorCurrentWeight.length;c++)b-=this.m_vectorCurrentWeight[c];return b};a.getMorphTargetCount=function(){return this.m_vectorCurrentWeight.length};
a.update=function(b){for(var c=0;c<this.m_vectorCurrentWeight.length;c++){var d=this.m_vectorCurrentWeight[c],e=this.m_vectorEndWeight[c],f=this.m_vectorDuration[c];if(b>=f){this.m_vectorCurrentWeight[c]=e;this.m_vectorDuration[c]=0}else{this.m_vectorCurrentWeight[c]+=(e-d)*b/f;this.m_vectorDuration[c]-=b}}for(b=0;b<this.m_vectorCurrentWeight.length;b++){c=this.m_model.getCoreModel().getCoreMorphAnimation(b);d=c.getVectorCoreMeshID();e=c.getVectorMorphTargetID();for(c=0;c<d.length;c++){f=this.m_model.getMesh(d[c]).getVectorSubmesh();
for(var g=f.length,h=0;h<g;h++)f[h].setMorphTargetWeight(e[c],this.m_vectorCurrentWeight[b])}}};Cal3D.CalPlane=function(){this.d=this.c=this.b=this.a=0};Cal3D.CalPlane.prototype.eval=function(b){return b.x*this.a+b.y*this.b+b.z*this.c+this.d};Cal3D.CalPlane.prototype.setPosition=function(b){this.d=-b.x*this.a-b.y*this.b-b.z*this.c};Cal3D.CalPlane.prototype.setNormal=function(b){this.a=b.x;this.b=b.y;this.c=b.z;this.d=-1.0E32};Cal3D.CalPlane.prototype.dist=function(b){return Math.abs((b.x*this.a+b.y*this.b+b.z*this.c+this.d)/Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c))};
Cal3D.CalBoundingBox=function(){this.plane=[new Cal3D.CalPlane,new Cal3D.CalPlane,new Cal3D.CalPlane,new Cal3D.CalPlane,new Cal3D.CalPlane,new Cal3D.CalPlane]};
Cal3D.CalBoundingBox.prototype.computePoints=function(b){if(!b||!(b instanceof Array)||b.length<8)b=new Array(8);for(var c=new Cal3D.CalMatrix,d=this.plane,e=0,f=0;f<2;f++)for(var g=2;g<4;g++)for(var h=4;h<6;h++){var m,l,p;c.dxdx=d[f].a;c.dxdy=d[f].b;c.dxdz=d[f].c;c.dydx=d[g].a;c.dydy=d[g].b;c.dydz=d[g].c;c.dzdx=d[h].a;c.dzdy=d[h].b;c.dzdz=d[h].c;p=c.det();if(p!=0){c.dxdx=-d[f].d;c.dxdy=d[f].b;c.dxdz=d[f].c;c.dydx=-d[g].d;c.dydy=d[g].b;c.dydz=d[g].c;c.dzdx=-d[h].d;c.dzdy=d[h].b;c.dzdz=d[h].c;m=c.det()/
p;c.dxdx=d[f].a;c.dxdy=-d[f].d;c.dxdz=d[f].c;c.dydx=d[g].a;c.dydy=-d[g].d;c.dydz=d[g].c;c.dzdx=d[h].a;c.dzdy=-d[h].d;c.dzdz=d[h].c;l=c.det()/p;c.dxdx=d[f].a;c.dxdy=d[f].b;c.dxdz=-d[f].d;c.dydx=d[g].a;c.dydy=d[g].b;c.dydz=-d[g].d;c.dzdx=d[h].a;c.dzdy=d[h].b;c.dzdz=-d[h].d;p=c.det()/p;if(b[e])b[e].assign(m,l,p);else b[e]=new Cal3D.CalVector(m,l,p)}else if(b[e])b[e].assign(0,0,0);else b[e]=new Cal3D.CalVector(0,0,0);e++}return b};Cal3D.CalAbstractMixer=function(){};Cal3D.CalAbstractMixer.prototype.isDefaultMixer=function(){return false};Cal3D.CalAbstractMixer.prototype.updateAnimation=function(){throw"abstract method error";};Cal3D.CalAbstractMixer.prototype.updateSkeleton=function(){throw"abstract method error";};
Cal3D.CalMixer=function(b){this.m_model=b;this.m_vectorAnimation=new Array(b.getCoreModel().getCoreAnimationCount());this.m_listAnimationAction=[];this.m_listAnimationCycle=[];this.m_animationDuration=this.m_animationTime=0;this.m_timeFactor=1};Cal3D.CalMixer.prototype=new Cal3D.CalAbstractMixer;a=Cal3D.CalMixer.prototype;a.isDefaultMixer=function(){return true};
a.blendCycle=function(b,c,d){if(b<0||b>=this.m_vectorAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"mixer.js");return false}var e=this.m_vectorAnimation[b];if(!e){if(c==0)return true;e=this.m_model.getCoreModel().getCoreAnimation(b);if(!e)return false;Cal3D.addExtraKeyframeForLoopedAnim(e);e=new Cal3D.CalAnimationCycle(e);this.m_vectorAnimation[b]=e;this.m_listAnimationCycle.unshift(e);return e.blend(c,d)}if(e.getType()!=Cal3D.CalAnimation.Type.TYPE_CYCLE){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_ANIMATION_TYPE,
"mixer.js");return false}if(c==0)this.m_vectorAnimation[b]=null;e=e;e.blend(c,d);e.checkCallbacks(0,this.m_model);return true};
a.clearCycle=function(b,c){if(b<0||b>=this.m_vectorAnimation.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"mixer.js");return false}var d=this.m_vectorAnimation[b];if(!d)return true;if(d.getType()!=Cal3D.CalAnimation.Type.TYPE_CYCLE){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_ANIMATION_TYPE,"mixer.js");return false}this.m_vectorAnimation[b]=null;d.setAsync(this.m_animationTime,this.m_animationDuration);d.blend(0,c);d.checkCallbacks(0,this.m_model);return true};
a.executeAction=function(b,c,d,e,f){b=this.m_model.getCoreModel().getCoreAnimation(b);if(!b)return false;b=new Cal3D.CalAnimationAction(b);this.m_listAnimationAction.unshift(b);b.execute(c,d,e,f);b.checkCallbacks(0,this.m_model);return true};
a.removeAction=function(b){b=this.m_model.getCoreModel().getCoreAnimation(b);if(!b)return false;for(var c=0;c<this.m_listAnimationAction.length;){if(this.m_listAnimationAction[c].getCoreAnimation()==b){this.m_listAnimationAction[c].completeCallbacks(this.m_model);this.m_listAnimationAction.splice(c,1);return true}c++}return false};
a.updateAnimation=function(b){if(this.m_animationDuration==0)this.m_animationTime=0;else{this.m_animationTime+=b*this.m_timeFactor;if(this.m_animationTime>=this.m_animationDuration||this.m_animationTime<0)this.m_animationTime%=this.m_animationDuration;if(this.m_animationTime<0)this.m_animationTime+=this.m_animationDuration}for(var c=0;c<this.m_listAnimationAction.length;){var d=this.m_listAnimationAction[c];if(d.update(b)){d.checkCallbacks(d.getTime(),this.m_model);c++}else{d.completeCallbacks(this.m_model);
this.m_listAnimationAction.splice(c,1)}}for(var e=d=c=0;e<this.m_listAnimationCycle.length;){var f=this.m_listAnimationCycle[e];if(f.update(b)){if(f.getState()==Cal3D.CalAnimation.State.STATE_SYNC){c+=f.getWeight();d+=f.getWeight()*f.getCoreAnimation().getDuration()}f.checkCallbacks(this.m_animationTime,this.m_model);e++}else{f.completeCallbacks(this.m_model);this.m_listAnimationCycle.splice(e,1)}}this.m_animationDuration=c>0?d/c:0};
a.updateSkeleton=function(){var b=this.m_model.getSkeleton();if(b){b.clearState();for(var c=b.getVectorBone(),d=new Cal3D.CalVector,e=new Cal3D.CalQuaternion,f=0;f<this.m_listAnimationAction.length;f++){var g=this.m_listAnimationAction[f],h=g.getCoreAnimation();h=h.getListCoreTrack();for(var m=0;m<h.length;m++){var l=c[h[m].getCoreBoneId()];h[m].getState(g.getTime(),d,e);l.blendState(g.getWeight(),d,e)}}b.lockState();for(f=0;f<this.m_listAnimationCycle.length;f++){g=this.m_listAnimationCycle[f];h=
g.getCoreAnimation();var p;p=g.getState()==Cal3D.CalAnimation.State.STATE_SYNC?this.m_animationDuration==0?0:this.m_animationTime*h.getDuration()/this.m_animationDuration:g.getTime();h=h.getListCoreTrack();for(m=0;m<h.length;m++){l=c[h[m].getCoreBoneId()];h[m].getState(p,d,e);l.blendState(g.getWeight(),d,e)}}b.lockState();b.calculateState()}};a.getAnimationTime=function(){return this.m_animationTime};a.getAnimationDuration=function(){return this.m_animationDuration};
a.setAnimationTime=function(b){this.m_animationTime=b};a.setTimeFactor=function(b){this.m_timeFactor=b};a.getTimeFactor=function(){return this.m_timeFactor};a.getCalModel=function(){return this.m_model};a.getAnimationVector=function(){return this.m_vectorAnimation};a.getAnimationActionList=function(){return this.m_listAnimationAction};a.getAnimationCycle=function(){return this.m_listAnimationCycle};
Cal3D.addExtraKeyframeForLoopedAnim=function(b){var c=b.getListCoreTrack();if(c.length!=0){var d=0;if(c[d])if(d=c[d].getCoreKeyframe(c[d].getCoreKeyframeCount()-1))if(d.getTime()<b.getDuration())for(d=0;d<c.length;d++){var e=c[d],f=e.getCoreKeyframe(0),g=new Cal3D.CalCoreKeyframe;g.setTranslation(f.getTranslation());g.setRotation(f.getRotation());g.setTime(b.getDuration());e.addCoreKeyframe(g)}}};Cal3D.CalPhysique=function(b){this.m_model=b;this.m_normalize=true;this.m_axisFactorZ=this.m_axisFactorY=this.m_axisFactorX=1};a=Cal3D.CalPhysique.prototype;
a.calculateTangentSpaces=function(b,c,d,e){if(c<0||c>=b.getCoreSubmesh().getVectorVectorTangentSpace().length)return 0;if(e==undefined||e<=0)e=4;if(d.length<b.getVertexCount()*e)return 0;var f=this.m_model.getSkeleton().getVectorBone(),g=b.getCoreSubmesh().getVectorVertex();c=b.getCoreSubmesh().getVectorVectorTangentSpace()[c];b=b.getVertexCount();for(var h=0,m=new Cal3D.CalVector,l=0;l<b;l++){var p=c[l],q=g[l],o,k,n;n=k=o=0;for(var s=q.vectorInfluence.length,r=0;r<s;r++){var t=q.vectorInfluence[r],
u=f[t.boneId];m.assign(p.tangent);m.multMatrixLocal(u.getTransformMatrix());o+=t.weight*m.x;k+=t.weight*m.y;n+=t.weight*m.z}if(this.m_normalize){o/=this.m_axisFactorX;k/=this.m_axisFactorY;n/=this.m_axisFactorZ;q=1/Math.sqrt(o*o+k*k+n*n);d[h]=o*q;d[h+1]=k*q;d[h+2]=n*q}else{d[h]=o;d[h+1]=k;d[h+2]=n}d[h+3]=p.crossFactor;h+=e}return b};
a.calculateNormals=function(b,c,d){if(d==undefined||d<=0)d=3;if(c.length<b.getVertexCount()*d)return 0;for(var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex(),g=b.getVertexCount(),h=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),m=b.getBaseWeight(),l=b.getMorphTargetWeightCount(),p=0,q=new Cal3D.CalVector,o=new Cal3D.CalVector,k=0;k<g;k++){var n=f[k];if(m==1){q.x=n.normal.x;q.y=n.normal.y;q.z=n.normal.z}else{q.x=m*n.normal.x;q.y=m*n.normal.y;q.z=m*n.normal.z;
for(var s=0;s<l;s++){var r=h[s].getVectorBlendVertex()[k],t=b.getMorphTargetWeight(s);q.x+=t*r.normal.x;q.y+=t*r.normal.y;q.z+=t*r.normal.z}}t=r=s=0;var u=n.vectorInfluence.length;if(u==0){s=q.x;r=q.y;t=q.z}else for(var v=0;v<u;v++){var w=n.vectorInfluence[v],x=e[w.boneId];o.assign(q);o.multMatrixLocal(x.getTransformMatrix());s+=w.weight*o.x;r+=w.weight*o.y;t+=w.weight*o.z}if(this.m_normalize){s/=this.m_axisFactorX;r/=this.m_axisFactorY;t/=this.m_axisFactorZ;n=1/Math.sqrt(s*s+r*r+t*t);c[p]=s*n;c[p+
1]=r*n;c[p+2]=t*n}else{c[p]=s;c[p+1]=r;c[p+2]=t}p+=d}return g};
a.calculateVertices=function(b,c,d){if(d==undefined||d<=0)d=3;if(c.length<b.getVertexCount()*d)return 0;for(var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex(),g=b.getCoreSubmesh().getVectorPhysicalProperty(),h=b.getVertexCount(),m=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),l=b.getBaseWeight(),p=b.getMorphTargetWeightCount(),q=0,o=new Cal3D.CalVector,k=new Cal3D.CalVector,n=0;n<h;n++){var s=f[n];o.assign(0,0,0);if(l==1){o.x=s.position.x;o.y=s.position.y;o.z=
s.position.z}else{o.x=l*s.position.x;o.y=l*s.position.y;o.z=l*s.position.z;for(var r=0;r<p;r++){var t=m[r].getVectorBlendVertex()[n],u=b.getMorphTargetWeight(r);o.x+=u*t.position.x;o.y+=u*t.position.y;o.z+=u*t.position.z}}u=t=r=0;var v=s.vectorInfluence.length;if(v==0){r=o.x;t=o.y;u=o.z}else for(var w=0;w<v;w++){var x=s.vectorInfluence[w],y=e[x.boneId];k.assign(o);k.multMatrixLocal(y.getTransformMatrix());k.addLocal(y.getTranslationBoneSpace());r+=x.weight*k.x;t+=x.weight*k.y;u+=x.weight*k.z}if(b.getCoreSubmesh().getSpringCount()>
0&&b.hasInternalData()){if(g[n].weight==0){c[q]=r*this.m_axisFactorX;c[q+1]=t*this.m_axisFactorY;c[q+2]=u*this.m_axisFactorZ}}else{c[q]=r*this.m_axisFactorX;c[q+1]=t*this.m_axisFactorY;c[q+2]=u*this.m_axisFactorZ}q+=d}return h};
a.calculateVertex=function(b,c){var d=this.m_model.getSkeleton().getVectorBone(),e=b.getCoreSubmesh().getVectorVertex(),f=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),g=b.getBaseWeight(),h=b.getMorphTargetWeightCount();e=e[c];var m=new Cal3D.CalVector(0,0,0);if(g==1){m.x=e.position.x;m.y=e.position.y;m.z=e.position.z}else{m.x=g*e.position.x;m.y=g*e.position.y;m.z=g*e.position.z;for(g=0;g<h;g++){var l=f[g].getVectorBlendVertex()[c],p=b.getMorphTargetWeight(g);m.x+=p*l.position.x;m.y+=p*l.position.y;
m.z+=p*l.position.z}}f=c=b=0;h=new Cal3D.CalVector;g=e.vectorInfluence.length;if(g==0){b=m.x;c=m.y;f=m.z}else for(l=0;l<g;l++){p=e.vectorInfluence[l];var q=d[p.boneId];h.assign(m);h.multMatrixLocal(q.getTransformMatrix());h.addLocal(q.getTranslationBoneSpace());b+=p.weight*h.x;c+=p.weight*h.y;f+=p.weight*h.z}return new Cal3D.CalVector(b*this.m_axisFactorX,c*this.m_axisFactorY,f*this.m_axisFactorZ)};
a.calculateVerticesAndNormals=function(b,c,d){if(d==undefined||d<=0)d=6;if(c.length<b.getVertexCount()*d)return 0;for(var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex(),g=b.getCoreSubmesh().getVectorPhysicalProperty(),h=b.getVertexCount(),m=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),l=b.getBaseWeight(),p=b.getMorphTargetWeightCount(),q=0,o=new Cal3D.CalVector,k=new Cal3D.CalVector,n=new Cal3D.CalVector,s=new Cal3D.CalVector,r=0;r<h;r++){var t=f[r];n.assign(0,
0,0);s.assign(0,0,0);if(l==1){n.x=t.position.x;n.y=t.position.y;n.z=t.position.z;s.x=t.normal.x;s.y=t.normal.y;s.z=t.normal.z}else{n.x=l*t.position.x;n.y=l*t.position.y;n.z=l*t.position.z;s.x=l*t.normal.x;s.y=l*t.normal.y;s.z=l*t.normal.z;for(var u=0;u<p;u++){var v=m[u].getVectorBlendVertex()[r],w=b.getMorphTargetWeight(u);n.x+=w*v.position.x;n.y+=w*v.position.y;n.z+=w*v.position.z;s.x+=w*v.normal.x;s.y+=w*v.normal.y;s.z+=w*v.normal.z}}var x,y,B;w=v=u=B=y=x=0;var D=t.vectorInfluence.length;if(D==
0){x=n.x;y=n.y;B=n.z;u=s.x;v=s.y;w=s.z}else for(var A=0;A<D;A++){var z=t.vectorInfluence[A],E=e[z.boneId];o.assign(n);o.multMatrixLocal(E.getTransformMatrix());o.addLocal(E.getTranslationBoneSpace());x+=z.weight*o.x;y+=z.weight*o.y;B+=z.weight*o.z;k.assign(s);k.multMatrixLocal(E.getTransformMatrix());u+=z.weight*k.x;v+=z.weight*k.y;w+=z.weight*k.z}if(b.getCoreSubmesh().getSpringCount()>0&&b.hasInternalData()){if(g[r].weight==0){c[q]=x*this.m_axisFactorX;c[q+1]=y*this.m_axisFactorY;c[q+2]=B*this.m_axisFactorZ}}else{c[q]=
x*this.m_axisFactorX;c[q+1]=y*this.m_axisFactorY;c[q+2]=B*this.m_axisFactorZ}if(this.m_normalize){u/=this.m_axisFactorX;v/=this.m_axisFactorY;w/=this.m_axisFactorZ;t=1/Math.sqrt(u*u+v*v+w*w);c[q+3]=u*t;c[q+4]=v*t;c[q+5]=w*t}else{c[q+3]=u;c[q+4]=v;c[q+5]=w}q+=d}return h};
a.calculateVerticesNormalsAndTexCoords=function(b,c,d){if(d==undefined)d=1;var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex(),g=b.getCoreSubmesh().getVectorVectorTextureCoordinate(),h=g.length;if(d<0||d>h)if(h!=0)return-1;for(var m=b.getCoreSubmesh().getVectorPhysicalProperty(),l=b.getVertexCount(),p=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),q=b.getBaseWeight(),o=b.getMorphTargetWeightCount(),k=0,n=new Cal3D.CalVector,s=new Cal3D.CalVector,r=0;r<l;r++){var t=
f[r];n.assign(0,0,0);s.assign(0,0,0);if(q==1){n.x=t.position.x;n.y=t.position.y;n.z=t.position.z;s.x=t.normal.x;s.y=t.normal.y;s.z=t.normal.z}else{n.x=q*t.position.x;n.y=q*t.position.y;n.z=q*t.position.z;s.x=q*t.normal.x;s.y=q*t.normal.y;s.z=q*t.normal.z;for(var u=0;u<o;u++){var v=p[u].getVectorBlendVertex()[r],w=b.getMorphTargetWeight(u);n.x+=w*v.position.x;n.y+=w*v.position.y;n.z+=w*v.position.z;s.x+=w*v.normal.x;s.y+=w*v.normal.y;s.z+=w*v.normal.z}}var x,y,B;w=v=u=B=y=x=0;var D=t.vectorInfluence.length;
if(D==0){x=n.x;y=n.y;B=n.z;u=s.x;v=s.y;w=s.z}else for(var A=0;A<D;A++){var z=t.vectorInfluence[A],E=e[z.boneId],C=new Cal3D.CalVector(n);C.multMatrixLocal(E.getTransformMatrix());C.addLocal(E.getTranslationBoneSpace());x+=z.weight*C.x;y+=z.weight*C.y;B+=z.weight*C.z;C=new Cal3D.CalVector(s);C.multMatrixLocal(E.getTransformMatrix());u+=z.weight*C.x;v+=z.weight*C.y;w+=z.weight*C.z}if(b.getCoreSubmesh().getSpringCount()>0&&b.hasInternalData()){if(m[r].weight==0){c[k]=x*this.m_axisFactorX;c[k+1]=y*this.m_axisFactorY;
c[k+2]=B*this.m_axisFactorZ}}else{c[k]=x*this.m_axisFactorX;c[k+1]=y*this.m_axisFactorY;c[k+2]=B*this.m_axisFactorZ}if(this.m_normalize){u/=this.m_axisFactorX;v/=this.m_axisFactorY;w/=this.m_axisFactorZ;t=1/Math.sqrt(u*u+v*v+w*w);c[k+3]=u*t;c[k+4]=v*t;c[k+5]=w*t}else{c[k+3]=u;c[k+4]=v;c[k+5]=w}k+=6;if(h==0)k+=d*2;else for(t=0;t<d;t++){u=g[t][r];c[k]=u.u;c[k+1]=u.v;k+=2}}return l};
a.update=function(){for(var b=this.m_model.getVectorMesh(),c=0;c<b.length;c++)for(var d=b[c].getVectorSubmesh(),e=0;e<d.length;e++){var f=d[e];if(f.hasInternalData()){var g=f.getVectorVertex(),h=f.getVectorNormal();this.calculateVerticesAndNormalsInternal(f,g,h);g=f.getVectorVectorTangentSpace().length;for(h=0;h<g;h++)if(f.isTangentsEnabled(h)){var m=f.getVectorVectorTangentSpace()[h];this.calculateTangentSpacesInternal(f,h,m)}}}};a.setNormalization=function(b){this.m_normalize=b};
a.setAxisFactorX=function(b){this.m_axisFactorX=b;this.m_normalize=true};a.setAxisFactorY=function(b){this.m_axisFactorY=b;this.m_normalize=true};a.setAxisFactorZ=function(b){this.m_axisFactorZ=b;this.m_normalize=true};
a.calculateVerticesAndNormalsInternal=function(b,c,d){if(c.length<b.getVertexCount()||d.length<b.getVertexCount())throw"internal error: buffer is not large enough to contain all the vertex/normal data";for(var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex(),g=b.getCoreSubmesh().getVectorPhysicalProperty(),h=b.getVertexCount(),m=b.getCoreSubmesh().getVectorCoreSubMorphTarget(),l=b.getBaseWeight(),p=b.getMorphTargetWeightCount(),q=new Cal3D.CalVector,o=new Cal3D.CalVector,
k=new Cal3D.CalVector,n=new Cal3D.CalVector,s=0;s<h;s++){var r=f[s];k.assign(0,0,0);n.assign(0,0,0);if(l==1){k.x=r.position.x;k.y=r.position.y;k.z=r.position.z;n.x=r.normal.x;n.y=r.normal.y;n.z=r.normal.z}else{k.x=l*r.position.x;k.y=l*r.position.y;k.z=l*r.position.z;n.x=l*r.normal.x;n.y=l*r.normal.y;n.z=l*r.normal.z;for(var t=0;t<p;t++){var u=m[t].getVectorBlendVertex()[s],v=b.getMorphTargetWeight(t);k.x+=v*u.position.x;k.y+=v*u.position.y;k.z+=v*u.position.z;n.x+=v*u.normal.x;n.y+=v*u.normal.y;n.z+=
v*u.normal.z}}var w,x,y;v=u=t=y=x=w=0;var B=r.vectorInfluence.length;if(B==0){w=k.x;x=k.y;y=k.z;t=n.x;u=n.y;v=n.z}else for(var D=0;D<B;D++){var A=r.vectorInfluence[D],z=e[A.boneId];q.assign(k);q.multMatrixLocal(z.getTransformMatrix());q.addLocal(z.getTranslationBoneSpace());w+=A.weight*q.x;x+=A.weight*q.y;y+=A.weight*q.z;o.assign(n);o.multMatrixLocal(z.getTransformMatrix());t+=A.weight*o.x;u+=A.weight*o.y;v+=A.weight*o.z}c[s]||(c[s]=new Cal3D.CalVector);d[s]||(d[s]=new Cal3D.CalVector);if(b.getCoreSubmesh().getSpringCount()>
0&&b.hasInternalData())g[s].weight==0&&c[s].assign(w*this.m_axisFactorX,x*this.m_axisFactorY,y*this.m_axisFactorZ);else c[s].assign(w*this.m_axisFactorX,x*this.m_axisFactorY,y*this.m_axisFactorZ);if(this.m_normalize){t/=this.m_axisFactorX;u/=this.m_axisFactorY;v/=this.m_axisFactorZ;r=1/Math.sqrt(t*t+u*u+v*v);d[s].assign(t*r,u*r,v*r)}else d[s].assign(t,u,v)}return h};
a.calculateTangentSpacesInternal=function(b,c,d){if(c<0||c>=b.getCoreSubmesh().getVectorVectorTangentSpace().length)throw"internal error: mapId is out of range";if(d.length<b.getVertexCount())throw"internal error: buffer is not large enough to contain all the tangent space data";var e=this.m_model.getSkeleton().getVectorBone(),f=b.getCoreSubmesh().getVectorVertex();c=b.getCoreSubmesh().getVectorVectorTangentSpace()[c];b=b.getVertexCount();for(var g=new Cal3D.CalVector,h=0;h<b;h++){var m=c[h],l=f[h],
p,q,o;o=q=p=0;for(var k=l.vectorInfluence.length,n=0;n<k;n++){var s=l.vectorInfluence[n],r=e[s.boneId];g.assign(m.tangent);g.multMatrixLocal(r.getTransformMatrix());p+=s.weight*g.x;q+=s.weight*g.y;o+=s.weight*g.z}d[h]||(d[h]=new Cal3D.CalCoreSubmesh.TangentSpace);if(this.m_normalize){p/=this.m_axisFactorX;q/=this.m_axisFactorY;o/=this.m_axisFactorZ;l=1/Math.sqrt(p*p+q*q+o*o);d[h].tangent.assign(p*l,q*l,o*l)}else d[h].tangent.assign(p,q,o);d[h].crossFactor=m.crossFactor}return b};Cal3D.CalSpringSystem=function(b){this.m_model=b;this.m_gravity=new Cal3D.CalVector(0,0,-98.1);this.m_force=new Cal3D.CalVector(0,0.5,0);this.m_collision=false};a=Cal3D.CalSpringSystem.prototype;a.calculateForces=function(b){var c=b.getVectorVertex(),d=b.getVectorPhysicalProperty();b=b.getCoreSubmesh().getVectorPhysicalProperty();for(var e=0;e<c.length;e++){var f=d[e],g=b[e];if(g.weight>0){f.force.assign(this.m_gravity);f.force.multScalarLocal(g.weight);f.force.addLocal(this.m_force)}}};
a.calculateVertices=function(b,c){for(var d=b.getVectorVertex(),e=b.getVectorPhysicalProperty(),f=b.getCoreSubmesh().getVectorPhysicalProperty(),g=0;g<d.length;g++){var h=d[g],m=e[g],l=f[g],p=new Cal3D.CalVector(m.position);if(l.weight>0){m.position.addLocal(Cal3D.vectorSub(p,m.positionOld).multScalarLocal(0.99).addLocal(Cal3D.vectorScalarMult(m.force,c*c/l.weight)));l=this.m_model.getSkeleton();if(this.m_collision){l=l.getVectorBone();for(var q=0;q<l.length;q++){for(var o=l[q].getBoundingBox(),k=
true,n=1E10,s=-1,r=0;r<6;r++)if(o.plane[r].eval(m.position)<=0)k=false;else{var t=o.plane[r].dist(m.position);if(t<n){s=r;n=t}}if(k&&s!=-1){k=new Cal3D.CalVector(o.plane[s].a,o.plane[s].b,o.plane[s].c);k.normalize();m.position.subLocal(Cal3D.vectorScalarMult(k,n))}k=true;for(r=0;r<6;r++)if(o.plane[r].eval(m.position)<0)k=false;k&&m.position.assign(d[g])}}}else m.position.assign(d[g]);m.positionOld.assign(p);h.assign(m.position);m.force.clear()}b=b.getCoreSubmesh().getVectorSpring();for(c=0;c<2;c++)for(g=
0;g<b.length;g++){h=b[g];m=Cal3D.vectorSub(d[h.vertexId[1]],d[h.vertexId[0]]);p=m.length();if(p>0){l=[0,0];l[0]=(p-h.idleLength)/p;l[1]=l[0];if(f[h.vertexId[0]].weight>0){l[0]/=2;l[1]/=2}else l[0]=0;if(f[h.vertexId[1]].weight<=0){l[0]*=2;l[1]=0}d[h.vertexId[0]].addLocal(Cal3D.vectorScalarMult(m,l[0]));e[h.vertexId[0]].position.assign(d[h.vertexId[0]]);d[h.vertexId[1]].subLocal(Cal3D.vectorScalarMult(m,l[1]));e[h.vertexId[1]].position.assign(d[h.vertexId[1]])}}};
a.update=function(b){for(var c=this.m_model.getVectorMesh(),d=0;d<c.length;d++)for(var e=c[d].getVectorSubmesh(),f=0;f<e.length;f++){var g=e[f];if(g.getCoreSubmesh().getSpringCount()>0&&g.hasInternalData()){this.calculateForces(g,b);this.calculateVertices(g,b)}}};a.getGravityVector=function(){return this.m_gravity};a.setGravityVector=function(b){this.m_gravity.assign(b)};a.getForceVector=function(){return this.m_force};a.setForceVector=function(b){this.m_force.assign(b)};
a.setCollisionDetection=function(b){this.m_collision=b};Cal3D.CalRenderer=function(b){this.m_selectedSubmesh=this.m_model=null;if(b instanceof Cal3D.CalModel)this.m_model=b;else if(b instanceof Cal3D.CalRenderer){this.m_model=b.m_model;this.m_selectedSubmesh=b.m_selectedSubmesh}else throw"argument error: input parameter is neither a model instance nor a renderer instance";};a=Cal3D.CalRenderer.prototype;
a.beginRendering=function(){var b=this.m_model.getVectorMesh();if(b.length==0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return false}this.m_selectedSubmesh=b[0].getSubmesh(0);if(!this.m_selectedSubmesh)return false;return true};a.endRendering=function(){this.m_selectedSubmesh=null};
a.getAmbientColor=function(b){var c=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(c){c=c.getAmbientColor();b[0]=c.red;b[1]=c.green;b[2]=c.blue;b[3]=c.alpha}else{b[0]=0;b[1]=0;b[2]=0;b[3]=0}};a.getDiffuseColor=function(b){var c=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(c){c=c.getDiffuseColor();b[0]=c.red;b[1]=c.green;b[2]=c.blue;b[3]=c.alpha}else{b[0]=192;b[1]=192;b[2]=192;b[3]=192}};a.getFaceCount=function(){return this.m_selectedSubmesh.getFaceCount()};
a.getFaces=function(b){return this.m_selectedSubmesh.getFaces(b)};a.getMapCount=function(){var b=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(!b)return 0;return b.getMapCount()};a.getMapUserData=function(b){var c=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(!c)return null;c=c.getVectorMap();if(b<0||b>=c.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return null}return c[b].userData};
a.getMeshCount=function(){return this.m_model.getVectorMesh().length};a.getNormals=function(b,c){if(this.m_selectedSubmesh.hasInternalData()){var d=this.m_selectedSubmesh.getVectorNormal(),e=this.m_selectedSubmesh.getVertexCount();if(c==undefined||c<=0)c=3;for(var f=0,g=0;f<e;f++,g+=c){var h=d[f];b[g]=h.x;b[g+1]=h.y;b[g+2]=h.z}return e}return this.m_model.getPhysique().calculateNormals(this.m_selectedSubmesh,b,c)};
a.getShininess=function(){var b=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(!b)return 50;return b.getShininess()};a.getSpecularColor=function(b){var c=this.m_model.getCoreModel().getCoreMaterial(this.m_selectedSubmesh.getCoreMaterialId());if(c){c=c.getSpecularColor();b[0]=c.red;b[1]=c.green;b[2]=c.blue;b[3]=c.alpha}else{b[0]=255;b[1]=255;b[2]=255;b[3]=0}};
a.getSubmeshCount=function(b){var c=this.m_model.getVectorMesh();if(b<0||b>=c.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return 0}return c[b].getSubmeshCount()};
a.getTextureCoordinates=function(b,c,d){var e=this.m_selectedSubmesh.getCoreSubmesh().getVectorVectorTextureCoordinate();if(b<0||b>=e.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return-1}var f=this.m_selectedSubmesh.getVertexCount();if(d==undefined||d<=0)d=2;for(var g=0,h=0;g<f;g++,h+=d){var m=e[b][g];c[h]=m.u;c[h+1]=m.v}return f};a.getVertexCount=function(){return this.m_selectedSubmesh.getVertexCount()};
a.getVertices=function(b,c){if(this.m_selectedSubmesh.hasInternalData()){var d=this.m_selectedSubmesh.getVectorVertex(),e=this.m_selectedSubmesh.getVertexCount();if(c==undefined||c<=0)c=3;for(var f=0,g=0;f<e;f++,g+=c){var h=d[f];b[g]=h.x;b[g+1]=h.y;b[g+2]=h.z}return e}return this.m_model.getPhysique().calculateVertices(this.m_selectedSubmesh,b,c)};
a.getTangentSpaces=function(b,c,d){var e=this.m_selectedSubmesh.getCoreSubmesh().getVectorVectorTangentSpace();if(b<0||b>=e.length||!this.m_selectedSubmesh.isTangentsEnabled(b)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return-1}if(this.m_selectedSubmesh.hasInternalData()){b=this.m_selectedSubmesh.getVectorVectorTangentSpace()[b];e=this.m_selectedSubmesh.getVertexCount();if(d==undefined||d<=0)d=4;for(var f=0,g=0;f<e;f++,g+=d){var h=b[f],m=h.tangent;c[g]=m.x;c[g+
1]=m.y;c[g+2]=m.z;c[g+3]=h.crossFactor}return e}return this.m_model.getPhysique().calculateTangentSpaces(this.m_selectedSubmesh,b,c,d)};
a.getVerticesAndNormals=function(b,c){if(this.m_selectedSubmesh.hasInternalData()){var d=this.m_selectedSubmesh.getVectorVertex(),e=this.m_selectedSubmesh.getVectorNormal(),f=this.m_selectedSubmesh.getVertexCount();if(c==undefined||c<=0)c=6;for(j=i=0;i<f;i++,j+=c){var g=d[i],h=e[i];b[j]=g.x;b[j+1]=g.y;b[j+2]=g.z;b[j+3]=h.x;b[j+4]=h.y;b[j+5]=h.z}return f}return this.m_model.getPhysique().calculateVerticesAndNormals(this.m_selectedSubmesh,b,c)};
a.getVerticesNormalsAndTexCoords=function(b,c){if(this.m_selectedSubmesh.hasInternalData()){var d=this.m_selectedSubmesh.getVectorVertex(),e=this.m_selectedSubmesh.getVectorNormal(),f=this.m_selectedSubmesh.getCoreSubmesh().getVectorVectorTextureCoordinate(),g=f.length;if(c==undefined)c=1;if(c<0||c>g)if(g!=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return-1}var h=this.m_selectedSubmesh.getVertexCount();if(g==0)for(var m=g=0;m<h;m++){var l=d[m],p=e[m];b[g]=l.x;
b[g+1]=l.y;b[g+2]=l.z;b[g+3]=p.x;b[g+4]=p.y;b[g+5]=p.z;g+=6+c*2}else if(c==1)for(m=g=0;m<h;m++){l=d[m];p=e[m];var q=f[0][m];b[g]=l.x;b[g+1]=l.y;b[g+2]=l.z;b[g+3]=p.x;b[g+4]=p.y;b[g+5]=p.z;b[g+6]=q.u;b[g+7]=q.v;g+=8}else for(m=g=0;m<h;m++){l=d[m];p=e[m];b[g]=l.x;b[g+1]=l.y;b[g+2]=l.z;b[g+3]=p.x;b[g+4]=p.y;b[g+5]=p.z;g+=6;for(l=0;l<c;l++){q=f[l][m];b[g]=q.u;b[g+1]=q.v;g+=2}}return h}return this.m_model.getPhysique().calculateVerticesNormalsAndTexCoords(this.m_selectedSubmesh,b,c)};
a.isTangentsEnabled=function(b){return this.m_selectedSubmesh.isTangentsEnabled(b)};a.selectMeshSubmesh=function(b,c){var d=this.m_model.getVectorMesh();if(b<0||b>=d.length){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_HANDLE,"renderer.js");return false}this.m_selectedSubmesh=d[b].getSubmesh(c);if(!this.m_selectedSubmesh)return false;return true};a.setNormalization=function(b){this.m_model.getPhysique().setNormalization(b)};Cal3D.CalMatrix=function(){this.dxdx=1;this.dxdy=this.dzdx=this.dydx=0;this.dydy=1;this.dydz=this.dxdz=this.dzdy=0;this.dzdz=1;this.assign.apply(this,arguments)};a=Cal3D.CalMatrix.prototype;
a.assign=function(){if(arguments.length==1)if(arguments[0]instanceof Cal3D.CalMatrix){var b=arguments[0];this.dxdx=b.dxdx;this.dydx=b.dydx;this.dzdx=b.dzdx;this.dxdy=b.dxdy;this.dydy=b.dydy;this.dzdy=b.dzdy;this.dxdz=b.dxdz;this.dydz=b.dydz;this.dzdz=b.dzdz}else{if(arguments[0]instanceof Cal3D.CalQuaternion){var c=arguments[0];b=c.x*c.x*2;var d=c.y*c.y*2,e=c.z*c.z*2,f=c.x*c.y*2,g=c.z*c.w*2,h=c.x*c.z*2,m=c.y*c.w*2,l=c.y*c.z*2;c=c.x*c.w*2;this.dxdx=1-d-e;this.dxdy=f+g;this.dxdz=h-m;this.dydx=f-g;this.dydy=
1-b-e;this.dydz=l+c;this.dzdx=h+m;this.dzdy=l-c;this.dzdz=1-b-d}}else if(arguments.length==2){b=arguments[0];d=arguments[1];this.dxdx=d.dxdx*b;this.dxdy=d.dxdy*b;this.dxdz=d.dxdz*b;this.dydx=d.dydx*b;this.dydy=d.dydy*b;this.dydz=d.dydz*b;this.dzdx=d.dzdx*b;this.dzdy=d.dzdy*b;this.dzdz=d.dzdz*b}else if(arguments.length==9){this.dxdx=arguments[0];this.dydx=arguments[1];this.dzdx=arguments[2];this.dxdy=arguments[3];this.dydy=arguments[4];this.dzdy=arguments[5];this.dxdz=arguments[6];this.dydz=arguments[7];
this.dzdz=arguments[8]}return this};
a.multMatrixLocal=function(b){var c=b.dydx*this.dxdx+b.dydy*this.dydx+b.dydz*this.dzdx,d=b.dzdx*this.dxdx+b.dzdy*this.dydx+b.dzdz*this.dzdx,e=b.dxdx*this.dxdy+b.dxdy*this.dydy+b.dxdz*this.dzdy,f=b.dydx*this.dxdy+b.dydy*this.dydy+b.dydz*this.dzdy,g=b.dzdx*this.dxdy+b.dzdy*this.dydy+b.dzdz*this.dzdy,h=b.dxdx*this.dxdz+b.dxdy*this.dydz+b.dxdz*this.dzdz,m=b.dydx*this.dxdz+b.dydy*this.dydz+b.dydz*this.dzdz,l=b.dzdx*this.dxdz+b.dzdy*this.dydz+b.dzdz*this.dzdz;this.dxdx=b.dxdx*this.dxdx+b.dxdy*this.dydx+
b.dxdz*this.dzdx;this.dydx=c;this.dzdx=d;this.dxdy=e;this.dydy=f;this.dzdy=g;this.dxdz=h;this.dydz=m;this.dzdz=l;return this};a.multScalarLocal=function(b){this.dxdx*=b;this.dydx*=b;this.dzdx*=b;this.dxdy*=b;this.dydy*=b;this.dzdy*=b;this.dxdz*=b;this.dydz*=b;this.dzdz*=b;return this};a.blend=function(b,c){this.dxdx+=c.dxdx*b;this.dydx+=c.dydx*b;this.dzdx+=c.dzdx*b;this.dxdy+=c.dxdy*b;this.dydy+=c.dydy*b;this.dzdy+=c.dzdy*b;this.dxdz+=c.dxdz*b;this.dydz+=c.dydz*b;this.dzdz+=c.dzdz*b};
a.det=function(){return this.dxdx*(this.dydy*this.dzdz-this.dydz*this.dzdy)-this.dxdy*(this.dydx*this.dzdz-this.dzdx*this.dydz)+this.dxdz*(this.dydx*this.dzdy-this.dzdx*this.dydy)};Cal3D.CalQuaternion=function(){this.z=this.y=this.x=0;this.w=1;this.assign.apply(this,arguments)};a=Cal3D.CalQuaternion.prototype;
a.assign=function(){if(arguments.length==1&&arguments[0]instanceof Cal3D.CalQuaternion){var b=arguments[0];this.x=b.x;this.y=b.y;this.z=b.z;this.w=b.w}else if(arguments.length==4){this.x=arguments[0];this.y=arguments[1];this.z=arguments[2];this.w=arguments[3]}return this};a.multQuaternionLocal=function(b){var c=this.x,d=this.y,e=this.z,f=this.w;this.x=f*b.x+c*b.w+d*b.z-e*b.y;this.y=f*b.y-c*b.z+d*b.w+e*b.x;this.z=f*b.z+c*b.y-d*b.x+e*b.w;this.w=f*b.w-c*b.x-d*b.y-e*b.z;return this};
a.multVectorLocal=function(b){var c=this.x,d=this.y,e=this.z,f=this.w;this.x=f*b.x+d*b.z-e*b.y;this.y=f*b.y-c*b.z+e*b.x;this.z=f*b.z+c*b.y-d*b.x;this.w=-c*b.x-d*b.y-e*b.z;return this};a.equalTo=function(b){return this.x==b.x&&this.y==b.y&&this.z==b.z&&this.w==b.w};
a.blend=function(b,c){var d=this.x*c.x+this.y*c.y+this.z*c.z+this.w*c.w,e=false;if(d<0){d=-d;e=true}if(1-d<1.0E-6)d=1-b;else{var f=Math.acos(d),g=1/Math.sin(f);d=Math.sin((1-b)*f)*g;b=Math.sin(b*f)*g}if(e)b=-b;this.x=d*this.x+b*c.x;this.y=d*this.y+b*c.y;this.z=d*this.z+b*c.z;this.w=d*this.w+b*c.w};a.clear=function(){this.z=this.y=this.x=0;this.w=1};a.conjugate=function(){this.x=-this.x;this.y=-this.y;this.z=-this.z};
a.invert=function(){this.conjugate();var b=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(b!=0){b=1/b;this.x*=b;this.y*=b;this.z*=b;this.w*=b}};Cal3D.quaternionMult=function(b,c){return new Cal3D.CalQuaternion(c.w*b.x+c.x*b.w+c.y*b.z-c.z*b.y,c.w*b.y-c.x*b.z+c.y*b.w+c.z*b.x,c.w*b.z+c.x*b.y-c.y*b.x+c.z*b.w,c.w*b.w-c.x*b.x-c.y*b.y-c.z*b.z)};
Cal3D.shortestArc=function(b,c){var d=Cal3D.vectorCross(b,c);b=Cal3D.vectorDot(b,c);b=Math.sqrt(2*(b+1));d.divScalarLocal(b);return new Cal3D.CalQuaternion(d.x,d.y,d.z,-b/2)};Cal3D.CalVector=function(){this.z=this.y=this.x=0;this.assign.apply(this,arguments)};a=Cal3D.CalVector.prototype;a.assign=function(){if(arguments.length==1&&arguments[0]instanceof Cal3D.CalVector){var b=arguments[0];this.x=b.x;this.y=b.y;this.z=b.z}else if(arguments.length==3){this.x=arguments[0];this.y=arguments[1];this.z=arguments[2]}return this};
a.addLocal=function(b){this.x+=b.x;this.y+=b.y;this.z+=b.z;return this};a.subLocal=function(b){this.x-=b.x;this.y-=b.y;this.z-=b.z;return this};a.multScalarLocal=function(b){this.x*=b;this.y*=b;this.z*=b;return this};a.multQuaternionLocal=function(b){var c=new Cal3D.CalQuaternion(-b.x,-b.y,-b.z,b.w);c.multVectorLocal(this).multQuaternionLocal(b);this.x=c.x;this.y=c.y;this.z=c.z;return this};
a.multMatrixLocal=function(b){var c=this.x,d=this.y,e=this.z;this.x=b.dxdx*c+b.dxdy*d+b.dxdz*e;this.y=b.dydx*c+b.dydy*d+b.dydz*e;this.z=b.dzdx*c+b.dzdy*d+b.dzdz*e;return this};a.divScalarLocal=function(b){this.x/=b;this.y/=b;this.z/=b;return this};a.equalTo=function(b){return this.x==b.x&&this.y==b.y&&this.z==b.z};a.blend=function(b,c){this.x+=b*(c.x-this.x);this.y+=b*(c.y-this.y);this.z+=b*(c.z-this.z)};a.clear=function(){this.z=this.y=this.x=0};
a.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};a.normalize=function(){var b=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);this.x/=b;this.y/=b;this.z/=b;return b};Cal3D.vectorAdd=function(b,c){return new Cal3D.CalVector(b.x+c.x,b.y+c.y,b.z+c.z)};Cal3D.vectorSub=function(b,c){return new Cal3D.CalVector(b.x-c.x,b.y-c.y,b.z-c.z)};Cal3D.vectorScalarMult=function(b,c){return new Cal3D.CalVector(b.x*c,b.y*c,b.z*c)};
Cal3D.vectorScalarDiv=function(b,c){return new Cal3D.CalVector(b.x/c,b.y/c,b.z/c)};Cal3D.vectorDot=function(b,c){return b.x*c.x+b.y*c.y+b.z*c.z};Cal3D.vectorCross=function(b,c){return new Cal3D.CalVector(b.y*c.z-b.z*c.y,b.z*c.x-b.x*c.z,b.x*c.y-b.y*c.x)};Cal3D.CalLibraryConstants={SKELETON_FILE_MAGIC:"CSF",ANIMATION_FILE_MAGIC:"CAF",MESH_FILE_MAGIC:"CMF",MATERIAL_FILE_MAGIC:"CRF",SKELETON_XMLFILE_MAGIC:"XSF",ANIMATION_XMLFILE_MAGIC:"XAF",MESH_XMLFILE_MAGIC:"XMF",MATERIAL_XMLFILE_MAGIC:"XRF",LIBRARY_VERSION:1100,CURRENT_FILE_VERSION:1100,EARLIEST_COMPATIBLE_FILE_VERSION:699};Cal3D.CalLoadingCallback=function(){};Cal3D.CalLoadingCallback.prototype.onload=function(){};Cal3D.CalLoadingCallback.prototype.onerror=function(){};
Cal3D.CalLoadingCallback.prototype.onprogress=function(){};Cal3D.CalLoader={};Cal3D.CalLoader.LOADER_ROTATE_X_AXIS=1;Cal3D.CalLoader.LOADER_INVERT_V_COORD=2;Cal3D.CalLoader.LOADER_FLIP_WINDING=4;Cal3D.CalLoader.setLoadingMode=function(b){Cal3D.CalLoader.loadingMode=b};
Cal3D.CalLoader.loadModelFromConfigFile=function(b,c){var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.parseConfigFile(this.responseText);if(e.skeletons.length==0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js");c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,"skeleton file")}else{var f=1+e.animations.length+
e.meshes.length+e.materials.length,g={skeletons:{},animations:{},meshes:{},materials:{}},h=function(){var o=new Cal3D.CalCoreModel("dummy");o.setCoreSkeleton(g.skeletons[e.path+e.skeletons[0]]);for(var k=0;k<e.animations.length;k++)o.addCoreAnimation(g.animations[e.path+e.animations[k]]);for(k=0;k<e.meshes.length;k++)o.addCoreMesh(g.meshes[e.path+e.meshes[k]]);for(k=0;k<e.materials.length;k++)o.addCoreMaterial(g.materials[e.path+e.materials[k]]);for(k=0;k<e.materials.length;k++){o.createCoreMaterialThread(k);
o.setCoreMaterialId(k,0,k)}o.getCoreSkeleton().calculateBoundingBoxes(o);o=new Cal3D.CalModel(o);for(k=0;k<e.meshes.length;k++)o.attachMesh(k);o.setMaterialSet(0);c&&c.onload&&c.onload({model:o,path:e.path,scale:e.scale},b)},m={};m.onload=function(o,k){g.animations[k]=o;--f==0&&h()};m.onerror=function(o,k){c&&c.onerror&&c.onerror(o,k)};var l={};l.onload=function(o,k){g.meshes[k]=o;--f==0&&h()};l.onerror=function(o,k){c&&c.onerror&&c.onerror(o,k)};var p={};p.onload=function(o,k){g.materials[k]=o;--f==
0&&h()};p.onerror=function(o,k){c&&c.onerror&&c.onerror(o,k)};var q={};q.onload=function(o,k){g.skeletons[k]=o;for(k=0;k<e.animations.length;k++)Cal3D.CalLoader.loadCoreAnimationFromFile(e.path+e.animations[k],o,m);for(k=0;k<e.meshes.length;k++)Cal3D.CalLoader.loadCoreMeshFromFile(e.path+e.meshes[k],l);for(k=0;k<e.materials.length;k++)Cal3D.CalLoader.loadCoreMaterialFromFile(e.path+e.materials[k],p);--f==0&&h()};q.onerror=function(o,k){c&&c.onerror&&c.onerror(o,k)};Cal3D.CalLoader.loadCoreSkeletonFromFile(e.path+
e.skeletons[0],q)}}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()};
Cal3D.CalLoader.loadCoreAnimationFromFile=function(b,c,d){if(b.length>=3&&b.substring(b.length-3,b.length).toUpperCase()==Cal3D.CalLibraryConstants.ANIMATION_XMLFILE_MAGIC)Cal3D.CalLoader.loadXmlCoreAnimation(b,c,d);else{var e=new XMLHttpRequest;e.open("GET",b,true);e.overrideMimeType("text/plain; charset=x-user-defined");e.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var f=Cal3D.CalLoader.loadCoreAnimationFromData(this.responseText,c);if(f){f.setFilename(b);
d&&d.onload&&d.onload(f,b)}else d&&d.onerror&&d.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};e.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);d&&d.onerror&&d.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};e.onprogress=function(f){d&&d.onprogress&&d.onprogress(f.position/f.totalSize,b)};e.send()}};
Cal3D.CalLoader.loadCoreAnimationFromData=function(b,c){if(b.substring(0,3)!=Cal3D.CalLibraryConstants.ANIMATION_FILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}b=new Cal3D.CalBufferSource(b.substring(4,b.length));var d=b.readInteger();if(isNaN(d)||d<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION||d>Cal3D.CalLibraryConstants.CURRENT_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}d=
new Cal3D.CalCoreAnimation;var e=b.readFloat();if(isNaN(e)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(e<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_ANIMATION_DURATION,"loader.js");return null}d.setDuration(e);var f=b.readInteger();if(isNaN(f)||f<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(var g=0;g<f;g++){var h=Cal3D.CalLoader.loadCoreTrack(b,c,e);if(!h){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}d.addCoreTrack(h)}return d};
Cal3D.CalLoader.loadCoreMaterialFromFile=function(b,c){if(b.length>=3&&b.substring(b.length-3,b.length).toUpperCase()==Cal3D.CalLibraryConstants.MATERIAL_XMLFILE_MAGIC)Cal3D.CalLoader.loadXmlCoreMaterial(b,c);else{var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.loadCoreMaterialFromData(this.responseText);if(e){e.setFilename(b);c&&c.onload&&
c.onload(e,b)}else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()}};
Cal3D.CalLoader.loadCoreMaterialFromData=function(b){if(b.substring(0,3)!=Cal3D.CalLibraryConstants.MATERIAL_FILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}b=new Cal3D.CalBufferSource(b.substring(4,b.length));var c=b.readInteger();if(isNaN(c)||c<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION||c>Cal3D.CalLibraryConstants.CURRENT_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");
return null}c=new Cal3D.CalCoreMaterial;var d=[0,0,0,0],e=new Cal3D.CalCoreMaterial.Color;b.readBytes(d,d.length);e.red=d[0];e.green=d[1];e.blue=d[2];e.alpha=d[3];var f=new Cal3D.CalCoreMaterial.Color;b.readBytes(d,d.length);f.red=d[0];f.green=d[1];f.blue=d[2];f.alpha=d[3];var g=new Cal3D.CalCoreMaterial.Color;b.readBytes(d,d.length);g.red=d[0];g.green=d[1];g.blue=d[2];g.alpha=d[3];d=b.readFloat();if(!b.ok()){b.setError();return null}c.setAmbientColor(e);c.setDiffuseColor(f);c.setSpecularColor(g);
c.setShininess(d);e=b.readInteger();if(isNaN(e)||e<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(!c.reserve(e)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.MEMORY_ALLOCATION_FAILED,"loader.js");return null}for(f=0;f<e;f++){g=new Cal3D.CalCoreMaterial.Map;g.filename=b.readString();g.userData=null;if(!b.ok()){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}c.setMap(f,g)}return c};
Cal3D.CalLoader.loadCoreMeshFromFile=function(b,c){if(b.length>=3&&b.substring(b.length-3,b.length).toUpperCase()==Cal3D.CalLibraryConstants.MESH_XMLFILE_MAGIC)Cal3D.CalLoader.loadXmlCoreMesh(b,c);else{var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.loadCoreMeshFromData(this.responseText);if(e){e.setFilename(b);c&&c.onload&&c.onload(e,
b)}else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()}};
Cal3D.CalLoader.loadCoreMeshFromData=function(b){if(b.substring(0,3)!=Cal3D.CalLibraryConstants.MESH_FILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}b=new Cal3D.CalBufferSource(b.substring(4,b.length));var c=b.readInteger();if(isNaN(c)||c<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION||c>Cal3D.CalLibraryConstants.CURRENT_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");return null}c=
b.readInteger();if(isNaN(c)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(var d=new Cal3D.CalCoreMesh,e=0;e<c;e++){var f=Cal3D.CalLoader.loadCoreSubmesh(b);if(!f)return null;d.addCoreSubmesh(f)}return d};
Cal3D.CalLoader.loadCoreSkeletonFromFile=function(b,c){if(b.length>=3&&b.substring(b.length-3,b.length).toUpperCase()==Cal3D.CalLibraryConstants.SKELETON_XMLFILE_MAGIC)Cal3D.CalLoader.loadXmlCoreSkeleton(b,c);else{var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/plain; charset=x-user-defined");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.loadCoreSkeletonFromData(this.responseText);if(e)c&&c.onload&&c.onload(e,
b);else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()}};
Cal3D.CalLoader.loadCoreSkeletonFromData=function(b){if(b.substring(0,3)!=Cal3D.CalLibraryConstants.SKELETON_FILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}b=new Cal3D.CalBufferSource(b.substring(4,b.length));var c=b.readInteger();if(isNaN(c)||c<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION||c>Cal3D.CalLibraryConstants.CURRENT_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");
return null}c=b.readInteger();if(isNaN(c)||c<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(var d=new Cal3D.CalCoreSkeleton,e=0;e<c;e++){var f=Cal3D.CalLoader.loadCoreBones(b);if(!f)return null;f.setCoreSkeleton(d);d.addCoreBone(f);d.mapCoreBoneName(e,f.getName())}d.calculateState();return d};
Cal3D.CalLoader.loadCoreBones=function(b){if(!b.ok()){b.setError();return null}var c=b.readString(),d,e,f;d=b.readFloat();e=b.readFloat();f=b.readFloat();var g,h,m,l;g=b.readFloat();h=b.readFloat();m=b.readFloat();l=b.readFloat();var p,q,o;p=b.readFloat();q=b.readFloat();o=b.readFloat();var k,n,s,r;k=b.readFloat();n=b.readFloat();s=b.readFloat();r=b.readFloat();var t=b.readInteger();g=new Cal3D.CalQuaternion(g,h,m,l);k=new Cal3D.CalQuaternion(k,n,s,r);d=new Cal3D.CalVector(d,e,f);if(Cal3D.CalLoader.loadingMode&
Cal3D.CalLoader.LOADER_ROTATE_X_AXIS)if(t==-1){e=new Cal3D.CalQuaternion(0.7071067811,0,0,0.7071067811);g.multQuaternionLocal(e);d.multQuaternionLocal(e)}if(!b.ok()){b.setError();return null}c=new Cal3D.CalCoreBone(c);c.setParentId(t);c.setTranslation(d);c.setRotation(g);c.setTranslationBoneSpace(new Cal3D.CalVector(p,q,o));c.setRotationBoneSpace(k);p=b.readInteger();if(isNaN(p)||p<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(;p>0;p--){q=b.readInteger();
if(isNaN(q)||q<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}c.addChildId(q)}return c};
Cal3D.CalLoader.loadCoreKeyframe=function(b){if(!b.ok()){b.setError();return null}var c=b.readFloat(),d,e,f;d=b.readFloat();e=b.readFloat();f=b.readFloat();var g,h,m,l;g=b.readFloat();h=b.readFloat();m=b.readFloat();l=b.readFloat();if(!b.ok()){b.setError();return null}b=new Cal3D.CalCoreKeyframe;if(!b.create())return null;b.setTime(c);b.setTranslation(new Cal3D.CalVector(d,e,f));b.setRotation(new Cal3D.CalQuaternion(g,h,m,l));return b};
Cal3D.CalLoader.loadCoreSubmesh=function(b){if(!b.ok()){b.setError();return null}var c=b.readInteger(),d=b.readInteger(),e=b.readInteger(),f=b.readInteger(),g=b.readInteger(),h=b.readInteger();if(!b.ok()){b.setError();return null}var m=new Cal3D.CalCoreSubmesh;m.setLodCount(f);m.setCoreMaterialThreadId(c);if(!m.reserve(d,h,e,g)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.MEMORY_ALLOCATION_FAILED,"loader.js");return null}for(c=0;c<h;c++)m.enableTangents(c,false);for(f=0;f<d;f++){var l=new Cal3D.CalCoreSubmesh.Vertex;
l.position.x=b.readFloat();l.position.y=b.readFloat();l.position.z=b.readFloat();l.normal.x=b.readFloat();l.normal.y=b.readFloat();l.normal.z=b.readFloat();l.collapseId=b.readInteger();l.faceCollapseCount=b.readInteger();if(!b.ok()){b.setError();return null}for(;c<h;c++){var p=new Cal3D.CalCoreSubmesh.TextureCoordinate;p.u=b.readFloat();p.v=b.readFloat();if(Cal3D.CalLoader.loadingMode&Cal3D.CalLoader.LOADER_INVERT_V_COORD)p.v=1-p.v;if(!b.ok()){b.setError();return null}m.setTextureCoordinate(f,c,p)}p=
b.readInteger();if(isNaN(p)||p<0){b.setError();return null}for(var q=0;q<p;q++){var o=new Cal3D.CalCoreSubmesh.Influence;o.boneId=b.readInteger();o.weight=b.readFloat();l.vectorInfluence.push(o);if(!b.ok()){b.setError();return null}}m.setVertex(f,l);if(g>0){l=new Cal3D.CalCoreSubmesh.PhysicalProperty;l.weight=b.readFloat();if(!b.ok()){b.setError();return null}m.setPhysicalProperty(f,l)}}for(d=0;d<g;d++){h=new Cal3D.CalCoreSubmesh.Spring;h.vertexId[0]=b.readInteger();h.vertexId[1]=b.readInteger();
h.springCoefficient=b.readFloat();h.idleLength=b.readFloat();if(!b.ok()){b.setError();return null}m.setSpring(d,h)}c=0;g=false;for(d=0;d<e;d++){h=new Cal3D.CalCoreSubmesh.Face;h.vertexId[0]=b.readInteger();h.vertexId[1]=b.readInteger();h.vertexId[2]=b.readInteger();if(!b.ok()){b.setError();return null}if(c==0){f=m.getVectorVertex();c=f[h.vertexId[0]];l=f[h.vertexId[1]];p=f[h.vertexId[2]];f=new Cal3D.CalVector(c.position);l=new Cal3D.CalVector(l.position);p=new Cal3D.CalVector(p.position);f=Cal3D.vectorSub(f,
l);l=Cal3D.vectorSub(p,l);f=Cal3D.vectorCross(f,l);f=Cal3D.vectorScalarDiv(f,f.length());c=new Cal3D.CalVector(c.normal);if(Cal3D.vectorDot(f,c)>0)g=true;if(Cal3D.CalLoader.loadingMode&Cal3D.CalLoader.LOADER_FLIP_WINDING)g=!g;c=1}if(g){f=h.vertexId[1];h.vertexId[1]=h.vertexId[2];h.vertexId[2]=f}m.setFace(d,h)}return m};
Cal3D.CalLoader.loadCoreTrack=function(b,c){if(!b.ok()){b.setError();return null}var d=b.readInteger();if(isNaN(d)||d<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var e=new Cal3D.CalCoreTrack;if(!e.create())return null;e.setCoreBoneId(d);var f=b.readInteger();if(isNaN(f)||f<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(var g=0;g<f;g++){var h=Cal3D.CalLoader.loadCoreKeyframe(b);if(!h){e.destroy();
return null}if(Cal3D.CalLoader.loadingMode&Cal3D.CalLoader.LOADER_ROTATE_X_AXIS)if(c&&c.getCoreBone(d).getParentId()==-1){var m=new Cal3D.CalQuaternion(0.7071067811,0,0,0.7071067811),l=new Cal3D.CalQuaternion(h.getRotation());l.multQuaternionLocal(m);h.setRotation(l);l=new Cal3D.CalVector(h.getTranslation());l.multQuaternionLocal(m);h.setTranslation(l)}e.addCoreKeyframe(h)}return e};
Cal3D.CalLoader.loadXmlCoreAnimation=function(b,c,d){var e=new XMLHttpRequest;e.open("GET",b,true);e.overrideMimeType("text/xml");e.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var f=Cal3D.CalLoader.parseXmlCoreAnimation(this.responseXML,c);if(f){f.setFilename(b);d&&d.onload&&d.onload(f,b)}else d&&d.onerror&&d.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};e.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",
0,b);d&&d.onerror&&d.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};e.onprogress=function(f){d&&d.onprogress&&d.onprogress(f.position/f.totalSize,b)};e.send()};
Cal3D.CalLoader.loadXmlCoreSkeleton=function(b,c){var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/xml");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.parseXmlCoreSkeleton(this.responseXML);if(e)c&&c.onload&&c.onload(e,b);else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,
b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()};
Cal3D.CalLoader.loadXmlCoreMesh=function(b,c){var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/xml");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.parseXmlCoreMesh(this.responseXML);if(e){e.setFilename(b);c&&c.onload&&c.onload(e,b)}else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,b);c&&c.onerror&&
c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()};
Cal3D.CalLoader.loadXmlCoreMaterial=function(b,c){var d=new XMLHttpRequest;d.open("GET",b,true);d.overrideMimeType("text/xml");d.onreadystatechange=function(){if(this.readyState==4)if(this.status==200||this.status==0){var e=Cal3D.CalLoader.parseXmlCoreMaterial(this.responseXML);if(e){e.setFilename(b);c&&c.onload&&c.onload(e,b)}else c&&c.onerror&&c.onerror(Cal3D.CalError.Code.INVALID_FILE_FORMAT,b)}};d.onerror=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.FILE_NOT_FOUND,"loader.js",0,
b);c&&c.onerror&&c.onerror(Cal3D.CalError.Code.FILE_NOT_FOUND,b)};d.onprogress=function(e){c&&c.onprogress&&c.onprogress(e.position/e.totalSize,b)};d.send()};
Cal3D.CalLoader.parseConfigFile=function(b){var c=/^\s*(\w+)\s*=\s*([^:*?"<>|\r\n]+)\s*$/,d={path:"",scale:1,skeletons:[],animations:[],meshes:[],materials:[]};b=b.split("\n");for(var e=0;e<b.length;e++){var f=c.exec(b[e]);if(f){var g=f[2];switch(f[1]){case "path":if(d.path==""){d.path=g;f=d.path.charAt(d.path.length-1);if(f!="/"&&f!="\\")d.path+="/"}break;case "scale":d.scale=parseFloat(g);break;case "skeleton":d.skeletons.push(g);break;case "animation":d.animations.push(g);break;case "mesh":d.meshes.push(g);
break;case "material":d.materials.push(g);break;default:break}}}return d};
Cal3D.CalLoader.parseXmlCoreAnimation=function(b,c){if(!b){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var d=b.firstChild;if(!d||d.tagName!="ANIMATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(d.hasAttribute("MAGIC")&&d.getAttribute("MAGIC")!=Cal3D.CalLibraryConstants.ANIMATION_XMLFILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(d.hasAttribute("VERSION")&&
parseInt(d.getAttribute("VERSION")<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");return null}var e=parseFloat(d.getAttribute("DURATION"));b=parseInt(d.getAttribute("NUMTRACKS"));var f=new Cal3D.CalCoreAnimation;if(e<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_ANIMATION_DURATION,"loader.js");return null}f.setDuration(e);d=d.firstElementChild;for(e=0;e<b;e++){if(!d||d.tagName!="TRACK"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}var g=new Cal3D.CalCoreTrack;if(!g.create())return null;var h=parseInt(d.getAttribute("BONEID"));g.setCoreBoneId(h);var m=parseInt(d.getAttribute("NUMKEYFRAMES"));if(m<=0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}for(var l=d.firstElementChild,p=0;p<m;p++){if(!l||l.tagName!="KEYFRAME"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var q=parseFloat(l.getAttribute("TIME")),o=l.firstElementChild;
if(!o||o.tagName!="TRANSLATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var k=Cal3D.CalLoader.pattern_float3.exec(o.textContent);if(!k){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var n,s,r;n=parseFloat(k[1]);s=parseFloat(k[2]);r=parseFloat(k[3]);k=o.nextElementSibling;if(!k||k.tagName!="ROTATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}k=Cal3D.CalLoader.pattern_float4.exec(k.textContent);
if(!k){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var t,u,v;o=parseFloat(k[1]);t=parseFloat(k[2]);u=parseFloat(k[3]);v=parseFloat(k[4]);k=new Cal3D.CalCoreKeyframe;if(!k.create())return null;k.setTime(q);k.setTranslation(new Cal3D.CalVector(n,s,r));k.setRotation(new Cal3D.CalQuaternion(o,t,u,v));if(Cal3D.CalLoader.loadingMode&Cal3D.CalLoader.LOADER_ROTATE_X_AXIS)if(c&&c.getCoreBone(h).getParentId()==-1){q=new Cal3D.CalQuaternion(0.7071067811,0,0,0.7071067811);
n=new Cal3D.CalQuaternion(k.getRotation());n.multQuaternionLocal(q);k.setRotation(n);n=new Cal3D.CalVector(k.getTranslation());n.multQuaternionLocal(q);k.setTranslation(n)}g.addCoreKeyframe(k);l=l.nextElementSibling}f.addCoreTrack(g);d=d.nextElementSibling}return f};
Cal3D.CalLoader.parseXmlCoreSkeleton=function(b){if(!b){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var c=b.firstChild;if(!c||c.tagName!="SKELETON"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("MAGIC")&&c.getAttribute("MAGIC")!=Cal3D.CalLibraryConstants.SKELETON_XMLFILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("VERSION")&&
parseInt(c.getAttribute("VERSION"))<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");return null}b=new Cal3D.CalCoreSkeleton;parseInt(c.getAttribute("NUMBONES"));for(c=c.firstElementChild;c;c=c.nextElementSibling){if(c.tagName!="BONE"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var d=c.getAttribute("NAME"),e=c.firstElementChild;if(!e||e.tagName!="TRANSLATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}var f=Cal3D.CalLoader.pattern_float3.exec(e.textContent);if(!f){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var g,h,m;g=parseFloat(f[1]);h=parseFloat(f[2]);m=parseFloat(f[3]);e=e.nextElementSibling;if(!e||e.tagName!="ROTATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f=Cal3D.CalLoader.pattern_float4.exec(e.textContent);if(!f){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}var l,p,q,o;l=parseFloat(f[1]);p=parseFloat(f[2]);q=parseFloat(f[3]);o=parseFloat(f[4]);var k=e.nextElementSibling;if(!k||k.tagName!="LOCALTRANSLATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f=Cal3D.CalLoader.pattern_float3.exec(k.textContent);if(!f){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var n,s;e=parseFloat(f[1]);n=parseFloat(f[2]);s=parseFloat(f[3]);var r=k.nextElementSibling;
if(!r||r.tagName!="LOCALROTATION"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f=Cal3D.CalLoader.pattern_float4.exec(r.textContent);if(!f){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var t,u;k=parseFloat(f[1]);t=parseFloat(f[2]);u=parseFloat(f[3]);f=parseFloat(f[4]);r=r.nextElementSibling;if(!r||r.tagName!="PARENTID"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var v=
parseInt(r.textContent);d=new Cal3D.CalCoreBone(d);d.setParentId(v);g=new Cal3D.CalVector(g,h,m);h=new Cal3D.CalQuaternion(l,p,q,o);if(Cal3D.CalLoader.loadingMode&Cal3D.CalLoader.LOADER_ROTATE_X_AXIS)if(v==-1){m=new Cal3D.CalQuaternion(0.7071067811,0,0,0.7071067811);h.multQuaternionLocal(m);g.multQuaternionLocal(m)}d.setTranslation(g);d.setRotation(h);d.setTranslationBoneSpace(new Cal3D.CalVector(e,n,s));d.setRotationBoneSpace(new Cal3D.CalQuaternion(k,t,u,f));for(e=r.nextElementSibling;e;e=e.nextElementSibling){if(e.tagName!=
"CHILDID"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}n=parseInt(e.textContent);d.addChildId(n)}d.setCoreSkeleton(b);b.addCoreBone(d)}b.calculateState();return b};
Cal3D.CalLoader.parseXmlCoreMesh=function(b){if(!b){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var c=b.firstChild;if(!c||c.tagName!="MESH"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("MAGIC")&&c.getAttribute("MAGIC")!=Cal3D.CalLibraryConstants.MESH_XMLFILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("VERSION")&&
parseInt(c.getAttribute("VERSION"))<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");return null}b=parseInt(c.getAttribute("NUMSUBMESH"));var d=new Cal3D.CalCoreMesh;c=c.firstElementChild;for(var e=0;e<b;e++){if(!c||c.tagName!="SUBMESH"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var f=parseInt(c.getAttribute("MATERIAL")),g=parseInt(c.getAttribute("NUMVERTICES")),
h=parseInt(c.getAttribute("NUMFACES")),m=parseInt(c.getAttribute("NUMLODSTEPS")),l=parseInt(c.getAttribute("NUMSPRINGS")),p=parseInt(c.getAttribute("NUMTEXCOORDS")),q=new Cal3D.CalCoreSubmesh;q.setLodCount(m);q.setCoreMaterialThreadId(f);if(!q.reserve(g,p,h,l)){Cal3D.CalError.setLastError(Cal3D.CalError.Code.MEMORY_ALLOCATION_FAILED,"loader.js");return null}f=c.firstElementChild;for(m=0;m<g;m++){if(!f||f.tagName!="VERTEX"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");
return null}var o=new Cal3D.CalCoreSubmesh.Vertex,k=f.firstElementChild;if(!k||k.tagName!="POS"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var n=Cal3D.CalLoader.pattern_float3.exec(k.textContent);if(!n){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}o.position.x=parseFloat(n[1]);o.position.y=parseFloat(n[2]);o.position.z=parseFloat(n[3]);k=k.nextElementSibling;if(!k||k.tagName!="NORM"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}n=Cal3D.CalLoader.pattern_float3.exec(k.textContent);if(!n){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}o.normal.x=parseFloat(n[1]);o.normal.y=parseFloat(n[2]);o.normal.z=parseFloat(n[3]);if((n=k.nextElementSibling)&&n.tagName=="COLLAPSEID"){o.collapseId=parseInt(n.textContent);n=n.nextElementSibling;if(!n||n.tagName!="COLLAPSECOUNT"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}o.faceCollapseCount=
parseInt(n.textContent);n=n.nextElementSibling}else{o.collapseId=-1;o.faceCollapseCount=0}k=n;for(var s=0;s<p;s++){if(!k||k.tagName!="TEXCOORD"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var r=new Cal3D.CalCoreSubmesh.TextureCoordinate;n=Cal3D.CalLoader.pattern_float2.exec(k.textContent);if(!n){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}r.u=parseFloat(n[1]);r.v=parseFloat(n[2]);if(Cal3D.CalLoader.loadingMode&
Cal3D.CalLoader.LOADER_INVERT_V_COORD)r.v=1-r.v;q.setTextureCoordinate(m,s,r);k=k.nextElementSibling}n=parseInt(f.getAttribute("NUMINFLUENCES"));if(n<0){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}k=k;for(s=0;s<n;s++){if(!k||k.tagName!="INFLUENCE"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}r=new Cal3D.CalCoreSubmesh.Influence;r.boneId=parseInt(k.getAttribute("ID"));r.weight=parseFloat(k.textContent);
o.vectorInfluence.push(r);k=k.nextElementSibling}q.setVertex(m,o);o=k;if(l>0){if(!o||o.tagName!="PHYSIQUE"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}n=new Cal3D.CalCoreSubmesh.PhysicalProperty;n.weight=parseFloat(o.textContent);q.setPhysicalProperty(m,n)}f=f.nextElementSibling}g=f;for(p=0;p<l;p++){if(!g||g.tagName!="SPRING"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f=new Cal3D.CalCoreSubmesh.Spring;
n=Cal3D.CalLoader.pattern_int2.exec(g.getAttribute("VERTEXID"));if(!n){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f.vertexId[0]=parseInt(n[1]);f.vertexId[1]=parseInt(n[2]);f.springCoefficient=parseFloat(g.getAttribute("COEF"));f.idleLength=parseFloat(g.getAttribute("LENGTH"));q.setSpring(p,f);g=g.nextElementSibling}l=g;for(g=0;g<h;g++){if(!l||l.tagName!="FACE"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}p=
new Cal3D.CalCoreSubmesh.Face;n=Cal3D.CalLoader.pattern_int3.exec(l.getAttribute("VERTEXID"));if(!n){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}p.vertexId[0]=parseInt(n[1]);p.vertexId[1]=parseInt(n[2]);p.vertexId[2]=parseInt(n[3]);q.setFace(g,p);l=l.nextElementSibling}d.addCoreSubmesh(q);c=c.nextElementSibling}return d};
Cal3D.CalLoader.parseXmlCoreMaterial=function(b){if(!b){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}var c=b.firstChild;if(!c||c.tagName!="MATERIAL"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("MAGIC")&&c.getAttribute("MAGIC")!=Cal3D.CalLibraryConstants.MATERIAL_XMLFILE_MAGIC){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}if(c.hasAttribute("VERSION")&&
parseInt(c.getAttribute("VERSION"))<Cal3D.CalLibraryConstants.EARLIEST_COMPATIBLE_FILE_VERSION){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION,"loader.js");return null}b=new Cal3D.CalCoreMaterial;var d=c.firstElementChild;if(!d||d.tagName!="AMBIENT"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}c=new Cal3D.CalCoreMaterial.Color;var e=Cal3D.CalLoader.pattern_int4.exec(d.textContent);if(!e){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}c.red=parseInt(e[1]);c.green=parseInt(e[2]);c.blue=parseInt(e[3]);c.alpha=parseInt(e[4]);var f=d.nextElementSibling;if(!f||f.tagName!="DIFFUSE"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}d=new Cal3D.CalCoreMaterial.Color;e=Cal3D.CalLoader.pattern_int4.exec(f.textContent);if(!e){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}d.red=parseInt(e[1]);d.green=parseInt(e[2]);d.blue=parseInt(e[3]);
d.alpha=parseInt(e[4]);var g=f.nextElementSibling;if(!g||g.tagName!="SPECULAR"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f=new Cal3D.CalCoreMaterial.Color;e=Cal3D.CalLoader.pattern_int4.exec(g.textContent);if(!e){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}f.red=parseInt(e[1]);f.green=parseInt(e[2]);f.blue=parseInt(e[3]);f.alpha=parseInt(e[4]);e=g.nextElementSibling;if(!e||e.tagName!="SHININESS"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,
"loader.js");return null}g=parseFloat(e.textContent);b.setAmbientColor(c);b.setDiffuseColor(d);b.setSpecularColor(f);b.setShininess(g);c=[];for(d=e.nextElementSibling;d;d=d.nextElementSibling){if(!d||d.tagName!="MAP"){Cal3D.CalError.setLastError(Cal3D.CalError.Code.INVALID_FILE_FORMAT,"loader.js");return null}c.push(d.textContent)}b.reserve(c.length);for(d=0;d<c.length;d++){e=new Cal3D.CalCoreMaterial.Map;e.filename=c[d];e.userData=null;b.setMap(d,e)}return b};Cal3D.CalLoader.loadingMode=0;
Cal3D.CalLoader.pattern_int2=/([-+]?\b\d+\b)\s+([-+]?\b\d+\b)/;Cal3D.CalLoader.pattern_int3=/([-+]?\b\d+\b)\s+([-+]?\b\d+\b)\s+([-+]?\b\d+\b)/;Cal3D.CalLoader.pattern_int4=/([-+]?\b\d+\b)\s+([-+]?\b\d+\b)\s+([-+]?\b\d+\b)\s+([-+]?\b\d+\b)/;Cal3D.CalLoader.pattern_float2=/([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)/;Cal3D.CalLoader.pattern_float3=/([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)/;
Cal3D.CalLoader.pattern_float4=/([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)\s+([-+]?\b(?:[0-9]*\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\b)/;Cal3D.CalBufferSource=function(b){this.m_buffer=b;this.m_offset=0};a=Cal3D.CalBufferSource.prototype;a.ok=function(){return this.m_buffer!=null};a.setError=function(){Cal3D.CalError.setLastError(Cal3D.CalError.Code.NULL_BUFFER,"datasource.js")};a.readBytes=function(b,c){if(!this.ok()||!b||c<=0)return 0;if(this.m_offset+c>this.m_buffer.length)c=this.m_buffer.length-this.m_offset;for(var d=0;d<c;d++)b[d]=this.m_buffer[this.m_offset+d].charCodeAt(0)&255;this.m_offset+=c;return c};
a.readFloat=function(){if(!this.ok())return NaN;if(this.m_offset+4>this.m_buffer.length)return NaN;var b=3,c=this.m_buffer[this.m_offset+b].charCodeAt(0)&255;b+=-1;var d=-7,e=c&(1<<-d)-1;c>>=-d;for(d+=8;d>0;){e=e*256+(this.m_buffer[this.m_offset+b].charCodeAt(0)&255);b+=-1;d-=8}var f=e&(1<<-d)-1;e>>=-d;for(d+=23;d>0;){f=f*256+(this.m_buffer[this.m_offset+b].charCodeAt(0)&255);b+=-1;d-=8}this.m_offset+=4;switch(e){case 0:e=-126;break;case 255:return f?NaN:(c?-1:1)*Infinity;default:f+=Math.pow(2,23);
e-=127;break}return(c?-1:1)*f*Math.pow(2,e-23)};a.readInteger=function(){if(!this.ok())return NaN;if(this.m_offset+4>this.m_buffer.length)return NaN;for(var b=0,c=1,d=0;d<4;d++){b+=(this.m_buffer[this.m_offset+d].charCodeAt(0)&255)*c;c*=256}if(b&2147483648)b-=4294967296;this.m_offset+=4;return b};a.readString=function(){if(!this.ok())return"";var b=this.readInteger();if(isNaN(b)||b<=0)return"";var c=this.m_buffer.substring(this.m_offset,this.m_offset+b-1);this.m_offset+=b;return c};Cal3D.CalError={};Cal3D.CalError.Code={OK:0,INTERNAL:1,INVALID_HANDLE:2,MEMORY_ALLOCATION_FAILED:3,FILE_NOT_FOUND:4,INVALID_FILE_FORMAT:5,FILE_PARSER_FAILED:6,INDEX_BUILD_FAILED:7,NO_PARSER_DOCUMENT:8,INVALID_ANIMATION_DURATION:9,BONE_NOT_FOUND:10,INVALID_ATTRIBUTE_VALUE:11,INVALID_KEYFRAME_COUNT:12,INVALID_ANIMATION_TYPE:13,FILE_CREATION_FAILED:14,FILE_WRITING_FAILED:15,INCOMPATIBLE_FILE_VERSION:16,NO_MESH_IN_MODEL:17,BAD_DATA_SOURCE:18,NULL_BUFFER:19,INVALID_MIXER_TYPE:20,MAX_ERROR_CODE:21};
Cal3D.CalError.getLastErrorCode=function(){return Cal3D.CalError.m_lastErrorCode};Cal3D.CalError.getLastErrorFile=function(){return Cal3D.CalError.m_lastErrorFile};Cal3D.CalError.getLastErrorLine=function(){return Cal3D.CalError.m_lastErrorLine};Cal3D.CalError.getLastErrorText=function(){return Cal3D.CalError.m_lastErrorText};Cal3D.CalError.printLastError=function(){throw"not implemented error";};
Cal3D.CalError.setLastError=function(b,c,d,e){if(b>=Cal3D.CalError.Code.MAX_ERROR_CODE)b=Cal3D.CalError.Code.INTERNAL;Cal3D.CalError.m_lastErrorCode=b;Cal3D.CalError.m_lastErrorFile=c!=undefined?c:"";Cal3D.CalError.m_lastErrorLine=d!=undefined?d:-1;Cal3D.CalError.m_lastErrorText=e!=undefined?e:""};
Cal3D.CalError.getErrorDescription=function(b){switch(b){case Cal3D.CalError.Code.OK:return"No error found";case Cal3D.CalError.Code.INTERNAL:return"Internal error";case Cal3D.CalError.Code.INVALID_HANDLE:return"Invalid handle as argument";case Cal3D.CalError.Code.MEMORY_ALLOCATION_FAILED:return"Memory allocation failed";case Cal3D.CalError.Code.FILE_NOT_FOUND:return"File not found";case Cal3D.CalError.Code.INVALID_FILE_FORMAT:return"Invalid file format";case Cal3D.CalError.Code.FILE_PARSER_FAILED:return"Parser failed to process file";
case Cal3D.CalError.Code.INDEX_BUILD_FAILED:return"Building of the index failed";case Cal3D.CalError.Code.NO_PARSER_DOCUMENT:return"There is no document to parse";case Cal3D.CalError.Code.INVALID_ANIMATION_DURATION:return"The duration of the animation is invalid";case Cal3D.CalError.Code.BONE_NOT_FOUND:return"Bone not found";case Cal3D.CalError.Code.INVALID_ATTRIBUTE_VALUE:return"Invalid attribute value";case Cal3D.CalError.Code.INVALID_KEYFRAME_COUNT:return"Invalid number of keyframes";case Cal3D.CalError.Code.INVALID_ANIMATION_TYPE:return"Invalid animation type";
case Cal3D.CalError.Code.FILE_CREATION_FAILED:return"Failed to create file";case Cal3D.CalError.Code.FILE_WRITING_FAILED:return"Failed to write to file";case Cal3D.CalError.Code.INCOMPATIBLE_FILE_VERSION:return"Incompatible file version";case Cal3D.CalError.Code.NO_MESH_IN_MODEL:return"No mesh attached to the model";case Cal3D.CalError.Code.BAD_DATA_SOURCE:return"Cannot read from data source";case Cal3D.CalError.Code.NULL_BUFFER:return"Memory buffer is null";case Cal3D.CalError.Code.INVALID_MIXER_TYPE:return"The CalModel mixer is not a CalMixer instance";
default:return"Unknown error"}};Cal3D.CalError.getLastErrorDescription=function(){return Cal3D.CalError.getErrorDescription(Cal3D.CalError.getLastErrorCode())};Cal3D.CalError.m_lastErrorCode=Cal3D.CalError.Code.OK;Cal3D.CalError.m_lastErrorFile="";Cal3D.CalError.m_lastErrorLine=-1;Cal3D.CalError.m_lastErrorText="";
